{{- if and .Values.backup.enabled .Values.backup.verify.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "aeterna.fullname" . }}-backup-verify
  labels:
    {{- include "aeterna.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.backup.verify.schedule | quote }}
  jobTemplate:
    spec:
      backoffLimit: 3
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            {{- include "aeterna.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: backup-verify
        spec:
          restartPolicy: OnFailure
          {{- with .Values.aeterna.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.global.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: backup-verify
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
              image: postgres:16-alpine
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  echo "Starting backup verification..."
                  
                  {{- if eq .Values.backup.destination.type "s3" }}
                  LATEST_BACKUP=$(aws s3 ls s3://{{ .Values.backup.destination.bucket }}/aeterna/ --recursive | sort | tail -1 | awk '{print $NF}')
                  if [ -z "$LATEST_BACKUP" ]; then
                    echo "ERROR: No backups found in S3"
                    exit 1
                  fi
                  echo "Found latest backup: $LATEST_BACKUP"
                  BACKUP_FILE="/tmp/$(basename $LATEST_BACKUP)"
                  aws s3 cp s3://{{ .Values.backup.destination.bucket }}/$LATEST_BACKUP $BACKUP_FILE
                  {{- else if eq .Values.backup.destination.type "gcs" }}
                  LATEST_BACKUP=$(gsutil ls -r gs://{{ .Values.backup.destination.bucket }}/aeterna | sort | tail -1)
                  if [ -z "$LATEST_BACKUP" ]; then
                    echo "ERROR: No backups found in GCS"
                    exit 1
                  fi
                  echo "Found latest backup: $LATEST_BACKUP"
                  BACKUP_FILE="/tmp/$(basename $LATEST_BACKUP)"
                  gsutil cp $LATEST_BACKUP $BACKUP_FILE
                  {{- else if eq .Values.backup.destination.type "azure" }}
                  LATEST_BACKUP=$(az storage blob list --account-name {{ .Values.backup.destination.storageAccount }} --container-name {{ .Values.backup.destination.container }} --prefix aeterna | sort | tail -1 | awk '{print $1}')
                  if [ -z "$LATEST_BACKUP" ]; then
                    echo "ERROR: No backups found in Azure"
                    exit 1
                  fi
                  echo "Found latest backup: $LATEST_BACKUP"
                  BACKUP_FILE="/tmp/$(basename $LATEST_BACKUP)"
                  az storage blob download --account-name {{ .Values.backup.destination.storageAccount }} --container-name {{ .Values.backup.destination.container }} --name $LATEST_BACKUP --file $BACKUP_FILE
                  {{- end }}
                  
                  echo "Verifying backup integrity..."
                  if pg_restore --list $BACKUP_FILE > /dev/null 2>&1; then
                    echo "SUCCESS: Backup verification passed"
                    echo "Backup file: $(basename $BACKUP_FILE)"
                    echo "Size: $(du -h $BACKUP_FILE | cut -f1)"
                    rm $BACKUP_FILE
                    exit 0
                  else
                    echo "ERROR: Backup verification failed - corrupted backup"
                    rm $BACKUP_FILE
                    exit 1
                  fi
              env:
                {{- if eq .Values.backup.destination.type "s3" }}
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.destination.credentialsSecret | quote }}
                      key: access-key
                      optional: true
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.destination.credentialsSecret | quote }}
                      key: secret-key
                      optional: true
                {{- else if eq .Values.backup.destination.type "gcs" }}
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: /var/secrets/gcs/key.json
                {{- else if eq .Values.backup.destination.type "azure" }}
                - name: AZURE_STORAGE_ACCOUNT_NAME
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.destination.credentialsSecret | quote }}
                      key: storage-account
                      optional: true
                - name: AZURE_STORAGE_ACCOUNT_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.backup.destination.credentialsSecret | quote }}
                      key: storage-key
                      optional: true
                {{- end }}
              {{- if eq .Values.backup.destination.type "gcs" }}
              volumeMounts:
                - name: gcs-credentials
                  mountPath: /var/secrets/gcs
                  readOnly: true
              {{- end }}
              resources:
                limits:
                  cpu: 500m
                  memory: 256Mi
                requests:
                  cpu: 250m
                  memory: 128Mi
          {{- if eq .Values.backup.destination.type "gcs" }}
          volumes:
            - name: gcs-credentials
              secret:
                secretName: {{ .Values.backup.destination.credentialsSecret | quote }}
          {{- end }}
          {{- with .Values.aeterna.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.aeterna.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
{{- end }}
