{{- if and .Values.aeterna.enabled .Values.grepai.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aeterna.fullname" . }}-grepai
  labels:
    {{- include "aeterna.labels" . | nindent 4 }}
    app.kubernetes.io/component: grepai
data:
  # GrepAI server configuration
  GREPAI_MCP_PORT: "9090"
  GREPAI_LOG_LEVEL: {{ .Values.observability.logging.level | quote }}
  GREPAI_LOG_FORMAT: {{ .Values.observability.logging.format | quote }}
  
  # Embedder configuration
  GREPAI_EMBEDDER_TYPE: {{ .Values.grepai.embedder.type | quote }}
  GREPAI_EMBEDDER_MODEL: {{ .Values.grepai.embedder.model | quote }}
  {{- if .Values.grepai.embedder.endpoint }}
  GREPAI_EMBEDDER_ENDPOINT: {{ .Values.grepai.embedder.endpoint | quote }}
  {{- else if eq .Values.grepai.embedder.type "ollama" }}
  GREPAI_EMBEDDER_ENDPOINT: {{ .Values.llm.ollama.host | quote }}
  {{- end }}
  
  # Storage backend configuration
  GREPAI_STORE_TYPE: {{ .Values.grepai.store.type | quote }}
  
  {{- if eq .Values.grepai.store.type "qdrant" }}
  # Qdrant configuration
  {{- if .Values.vectorBackend.qdrant.bundled }}
  GREPAI_QDRANT_URL: "http://{{ include "aeterna.fullname" . }}-qdrant:6333"
  {{- else }}
  GREPAI_QDRANT_URL: "http://{{ .Values.vectorBackend.qdrant.external.host }}:{{ .Values.vectorBackend.qdrant.external.port }}"
  {{- end }}
  GREPAI_QDRANT_COLLECTION_PREFIX: {{ .Values.grepai.store.qdrant.collectionPrefix | default "grepai_" | quote }}
  {{- end }}
  
  {{- if eq .Values.grepai.store.type "postgres" }}
  # PostgreSQL configuration
  {{- if .Values.postgresql.bundled }}
  GREPAI_POSTGRES_HOST: "{{ include "aeterna.fullname" . }}-postgresql-rw"
  GREPAI_POSTGRES_PORT: "5432"
  GREPAI_POSTGRES_DATABASE: {{ .Values.postgresql.external.database | default "aeterna" | quote }}
  {{- else }}
  GREPAI_POSTGRES_HOST: {{ .Values.postgresql.external.host | quote }}
  GREPAI_POSTGRES_PORT: {{ .Values.postgresql.external.port | quote }}
  GREPAI_POSTGRES_DATABASE: {{ .Values.postgresql.external.database | quote }}
  {{- end }}
  GREPAI_POSTGRES_SCHEMA: {{ .Values.grepai.store.postgres.schema | default "grepai" | quote }}
  GREPAI_POSTGRES_USERNAME: {{ .Values.postgresql.external.username | default "aeterna" | quote }}
  GREPAI_POSTGRES_SSL_MODE: {{ .Values.postgresql.external.sslMode | default "prefer" | quote }}
  {{- end }}
  
  # Init script for projects
  init-projects.sh: |
    #!/bin/sh
    set -e
    
    echo "GrepAI initialization starting..."
    
    {{- range .Values.grepai.projects }}
    echo "Initializing project: {{ .name }} at {{ .path }}"
    grepai init {{ .path }} \
      --embedder {{ $.Values.grepai.embedder.type }} \
      --store {{ $.Values.grepai.store.type }} \
      {{- if eq $.Values.grepai.embedder.type "ollama" }}
      --embedder-endpoint {{ $.Values.llm.ollama.host | quote }} \
      {{- end }}
      || echo "Warning: Failed to initialize {{ .name }}"
    {{- end }}
    
    echo "GrepAI initialization complete"
{{- end }}
