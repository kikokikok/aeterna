apiVersion: networking.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: aeterna-mtls
  namespace: aeterna
spec:
  mtls:
    mode: STRICT
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: aeterna-memory-authz
  namespace: aeterna
spec:
  selector:
    matchLabels:
      app: aeterna-memory
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/aeterna/sa/aeterna-sync"
              - "cluster.local/ns/aeterna/sa/aeterna"
      to:
        - operation:
            ports: ["8081"]
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: aeterna-knowledge-authz
  namespace: aeterna
spec:
  selector:
    matchLabels:
      app: aeterna-knowledge
  action: ALLOW
  rules:
    - from:
        - source:
            principals:
              - "cluster.local/ns/aeterna/sa/aeterna-sync"
              - "cluster.local/ns/aeterna/sa/aeterna"
      to:
        - operation:
            ports: ["8082"]
