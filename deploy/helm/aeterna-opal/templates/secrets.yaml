apiVersion: v1
kind: Secret
metadata:
  name: {{ include "aeterna-opal.fullname" . }}-secrets
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "aeterna-opal.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.secrets.masterToken }}
  master-token: {{ .Values.secrets.masterToken | quote }}
  {{- end }}
  {{- if .Values.secrets.clientToken }}
  client-token: {{ .Values.secrets.clientToken | quote }}
  {{- end }}
  {{- if .Values.secrets.broadcastUri }}
  broadcast-uri: {{ .Values.secrets.broadcastUri | quote }}
  {{- end }}
  {{- if .Values.postgresql.enabled }}
  database-url: {{ include "aeterna-opal.postgresUri" . | quote }}
  {{- else if .Values.secrets.databaseUrl }}
  database-url: {{ .Values.secrets.databaseUrl | quote }}
  {{- else if .Values.externalPostgresql.existingSecret }}
  {{- /* Database URL will be constructed at runtime from existing secret */ -}}
  {{- else }}
  database-url: "postgres://{{ .Values.externalPostgresql.username }}@{{ .Values.externalPostgresql.host }}:{{ .Values.externalPostgresql.port }}/{{ .Values.externalPostgresql.database }}"
  {{- end }}
---
{{- if and (not .Values.postgresql.enabled) .Values.externalPostgresql.existingSecret }}
{{- /* If using external PostgreSQL with an existing secret, create a reference secret */ -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "aeterna-opal.fullname" . }}-postgres-ref
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "aeterna-opal.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
type: Opaque
stringData:
  {{- /* This is a placeholder - actual secret lookup happens at runtime */ -}}
  note: "This chart expects {{ .Values.externalPostgresql.existingSecret }} to exist with key {{ .Values.externalPostgresql.existingSecretKey }}"
{{- end }}
