name: Helm Chart CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'charts/**'
      - '.github/workflows/helm-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'charts/**'
      - '.github/workflows/helm-ci.yml'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Helm Lint
        run: helm lint charts/aeterna

  template:
    name: Template Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        values:
          - default
          - local
          - production
          - hybrid
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Template with default values
        if: matrix.values == 'default'
        run: helm template aeterna charts/aeterna --debug

      - name: Template with example values
        if: matrix.values != 'default'
        run: helm template aeterna charts/aeterna -f charts/aeterna/examples/values-${{ matrix.values }}.yaml --debug

  kubeconform:
    name: Kubernetes Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          helm template aeterna charts/aeterna | kubeconform \
            -strict \
            -ignore-missing-schemas \
            -kubernetes-version 1.29.0 \
            -summary

  schema-validation:
    name: Values Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install jsonschema
        run: pip install jsonschema pyyaml

      - name: Validate values against schema
        run: |
          python -c "
          import json
          import yaml
          from jsonschema import validate, ValidationError

          with open('charts/aeterna/values.schema.json') as f:
              schema = json.load(f)
          
          with open('charts/aeterna/values.yaml') as f:
              values = yaml.safe_load(f)
          
          try:
              validate(instance=values, schema=schema)
              print('Values schema validation passed')
          except ValidationError as e:
              print(f'Schema validation failed: {e.message}')
              exit(1)
          "

  chart-testing:
    name: Chart Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: List changed charts
        id: list-changed
        run: |
          changed=$(ct list-changed --config .github/ct.yaml 2>/dev/null || echo "charts/aeterna")
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run chart-testing (lint)
        run: ct lint --config .github/ct.yaml --charts charts/aeterna

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [[ ! -f charts/aeterna/README.md ]]; then
            echo "ERROR: charts/aeterna/README.md is missing"
            exit 1
          fi

      - name: Check values documentation
        run: |
          if ! grep -q "## Values Reference" charts/aeterna/README.md; then
            echo "WARNING: Values Reference section missing from README"
          fi
