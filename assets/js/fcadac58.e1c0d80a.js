"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[7934],{1738(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"helm/tracing","title":"Distributed Tracing with Aeterna","description":"Aeterna exports traces via OpenTelemetry Protocol (OTLP) over gRPC. This guide covers integration with Jaeger and Grafana Tempo.","source":"@site/docs/helm/tracing.md","sourceDirName":"helm","slug":"/helm/tracing","permalink":"/aeterna/docs/helm/tracing","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/helm/tracing.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Log Aggregation with Aeterna","permalink":"/aeterna/docs/helm/logging"},"next":{"title":"Chart Versioning Strategy","permalink":"/aeterna/docs/helm/chart-versioning"}}');var t=r(4848),i=r(8453);const s={},l="Distributed Tracing with Aeterna",o={},c=[{value:"Enabling Tracing",id:"enabling-tracing",level:2},{value:"Jaeger Integration",id:"jaeger-integration",level:2},{value:"Deploy Jaeger with Helm",id:"deploy-jaeger-with-helm",level:3},{value:"Configure Aeterna for Jaeger",id:"configure-aeterna-for-jaeger",level:3},{value:"Verify Traces",id:"verify-traces",level:3},{value:"Grafana Tempo Integration",id:"grafana-tempo-integration",level:2},{value:"Deploy Tempo with Helm",id:"deploy-tempo-with-helm",level:3},{value:"Configure Aeterna for Tempo",id:"configure-aeterna-for-tempo",level:3},{value:"Configure Grafana Data Source",id:"configure-grafana-data-source",level:3},{value:"Sampling Strategies",id:"sampling-strategies",level:2},{value:"Trace Context Propagation",id:"trace-context-propagation",level:2},{value:"Network Policies",id:"network-policies",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"distributed-tracing-with-aeterna",children:"Distributed Tracing with Aeterna"})}),"\n",(0,t.jsx)(n.p,{children:"Aeterna exports traces via OpenTelemetry Protocol (OTLP) over gRPC. This guide covers integration with Jaeger and Grafana Tempo."}),"\n",(0,t.jsx)(n.h2,{id:"enabling-tracing",children:"Enabling Tracing"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'observability:\n  tracing:\n    enabled: true\n    endpoint: "http://jaeger-collector.observability.svc:4317"\n    samplingRatio: 0.1  # 10% of traces in production\n'})}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"observability.tracing.enabled"})," is ",(0,t.jsx)(n.code,{children:"true"}),", the following environment variables are injected into the Aeterna deployment:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Variable"}),(0,t.jsx)(n.th,{children:"Value"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"OTEL_EXPORTER_OTLP_ENDPOINT"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"observability.tracing.endpoint"})}),(0,t.jsx)(n.td,{children:"OTLP collector address"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"OTEL_SERVICE_NAME"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"aeterna"})}),(0,t.jsx)(n.td,{children:"Service identifier in traces"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"OTEL_TRACES_SAMPLER"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"parentbased_traceidratio"})}),(0,t.jsx)(n.td,{children:"Respects parent span decisions"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"OTEL_TRACES_SAMPLER_ARG"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"observability.tracing.samplingRatio"})}),(0,t.jsx)(n.td,{children:"Sampling ratio (0.0\u20131.0)"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"jaeger-integration",children:"Jaeger Integration"}),"\n",(0,t.jsx)(n.h3,{id:"deploy-jaeger-with-helm",children:"Deploy Jaeger with Helm"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm repo add jaegertracing https://jaegertracing.github.io/helm-charts\nhelm repo update\n\nhelm install jaeger jaegertracing/jaeger \\\n  --namespace observability --create-namespace \\\n  --set provisionDataStore.cassandra=false \\\n  --set allInOne.enabled=true \\\n  --set storage.type=memory \\\n  --set agent.enabled=false \\\n  --set collector.enabled=false \\\n  --set query.enabled=false\n"})}),"\n",(0,t.jsx)(n.p,{children:"For production with Elasticsearch storage:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm install jaeger jaegertracing/jaeger \\\n  --namespace observability --create-namespace \\\n  --set provisionDataStore.cassandra=false \\\n  --set storage.type=elasticsearch \\\n  --set storage.elasticsearch.host=elasticsearch.observability.svc \\\n  --set storage.elasticsearch.port=9200 \\\n  --set collector.replicaCount=2 \\\n  --set query.replicaCount=2\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configure-aeterna-for-jaeger",children:"Configure Aeterna for Jaeger"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'observability:\n  tracing:\n    enabled: true\n    # Jaeger all-in-one OTLP gRPC port\n    endpoint: "http://jaeger.observability.svc:4317"\n    samplingRatio: 0.1\n'})}),"\n",(0,t.jsx)(n.h3,{id:"verify-traces",children:"Verify Traces"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Port-forward to Jaeger UI\nkubectl port-forward svc/jaeger-query -n observability 16686:16686\n\n# Open http://localhost:16686 and select "aeterna" from the Service dropdown\n'})}),"\n",(0,t.jsx)(n.h2,{id:"grafana-tempo-integration",children:"Grafana Tempo Integration"}),"\n",(0,t.jsx)(n.h3,{id:"deploy-tempo-with-helm",children:"Deploy Tempo with Helm"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\n\nhelm install tempo grafana/tempo \\\n  --namespace observability --create-namespace \\\n  --set tempo.storage.trace.backend=local \\\n  --set tempo.storage.trace.local.path=/var/tempo/traces\n"})}),"\n",(0,t.jsx)(n.p,{children:"For production with S3 backend:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm install tempo grafana/tempo-distributed \\\n  --namespace observability --create-namespace \\\n  --set storage.trace.backend=s3 \\\n  --set storage.trace.s3.bucket=aeterna-traces \\\n  --set storage.trace.s3.endpoint=s3.amazonaws.com \\\n  --set storage.trace.s3.region=us-east-1 \\\n  --set compactor.config.compaction.block_retention=336h \\\n  --set ingester.replicas=3 \\\n  --set distributor.replicas=2\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configure-aeterna-for-tempo",children:"Configure Aeterna for Tempo"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'observability:\n  tracing:\n    enabled: true\n    # Tempo distributor OTLP gRPC endpoint\n    endpoint: "http://tempo-distributor.observability.svc:4317"\n    samplingRatio: 0.1\n'})}),"\n",(0,t.jsx)(n.h3,{id:"configure-grafana-data-source",children:"Configure Grafana Data Source"}),"\n",(0,t.jsx)(n.p,{children:"Add Tempo as a data source in Grafana:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: 1\ndatasources:\n  - name: Tempo\n    type: tempo\n    access: proxy\n    url: http://tempo-query-frontend.observability.svc:3100\n    jsonData:\n      httpMethod: GET\n      tracesToMetrics:\n        datasourceUid: prometheus\n        tags:\n          - key: service.name\n            value: service\n      serviceMap:\n        datasourceUid: prometheus\n      nodeGraph:\n        enabled: true\n      lokiSearch:\n        datasourceUid: loki\n"})}),"\n",(0,t.jsx)(n.h2,{id:"sampling-strategies",children:"Sampling Strategies"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Environment"}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.code,{children:"samplingRatio"})}),(0,t.jsx)(n.th,{children:"Rationale"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Development"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"1.0"})}),(0,t.jsx)(n.td,{children:"Capture all traces for debugging"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Staging"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"0.5"})}),(0,t.jsx)(n.td,{children:"Capture half for representative coverage"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Production"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"0.05"}),"\u2013",(0,t.jsx)(n.code,{children:"0.1"})]}),(0,t.jsx)(n.td,{children:"Balance visibility with overhead"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Incident"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"1.0"})}),(0,t.jsx)(n.td,{children:"Temporarily increase during incidents"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"To increase sampling during an incident without redeploying:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm upgrade aeterna ./charts/aeterna \\\n  --reuse-values \\\n  --set observability.tracing.samplingRatio=1.0\n"})}),"\n",(0,t.jsx)(n.h2,{id:"trace-context-propagation",children:"Trace Context Propagation"}),"\n",(0,t.jsxs)(n.p,{children:["Aeterna propagates W3C Trace Context headers (",(0,t.jsx)(n.code,{children:"traceparent"}),", ",(0,t.jsx)(n.code,{children:"tracestate"}),") on all outbound HTTP calls. Downstream services that support OpenTelemetry will automatically join the same trace."]}),"\n",(0,t.jsx)(n.p,{children:"Services that receive trace context:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"PostgreSQL (via instrumented connection pool)"}),"\n",(0,t.jsx)(n.li,{children:"Qdrant (via HTTP API calls)"}),"\n",(0,t.jsx)(n.li,{children:"Redis/Dragonfly (via instrumented client)"}),"\n",(0,t.jsx)(n.li,{children:"OPAL Server (via HTTP API)"}),"\n",(0,t.jsx)(n.li,{children:"Central Server (in hybrid/remote modes)"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"network-policies",children:"Network Policies"}),"\n",(0,t.jsxs)(n.p,{children:["If ",(0,t.jsx)(n.code,{children:"networkPolicy.enabled"})," is ",(0,t.jsx)(n.code,{children:"true"}),", ensure the OTLP collector endpoint is reachable from the Aeterna namespace. Add an egress rule:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-otlp-egress\n  namespace: aeterna\nspec:\n  podSelector:\n    matchLabels:\n      app.kubernetes.io/name: aeterna\n  policyTypes:\n    - Egress\n  egress:\n    - to:\n        - namespaceSelector:\n            matchLabels:\n              kubernetes.io/metadata.name: observability\n      ports:\n        - protocol: TCP\n          port: 4317\n"})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"No traces appearing:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Verify tracing is enabled: ",(0,t.jsx)(n.code,{children:"helm get values aeterna | grep tracing"})]}),"\n",(0,t.jsxs)(n.li,{children:["Check the OTLP endpoint is reachable: ",(0,t.jsx)(n.code,{children:"kubectl exec <aeterna-pod> -- curl -sf <endpoint>/v1/traces"})]}),"\n",(0,t.jsxs)(n.li,{children:["Review Aeterna logs for OTLP export errors: ",(0,t.jsx)(n.code,{children:"kubectl logs <aeterna-pod> | grep otel"})]}),"\n",(0,t.jsx)(n.li,{children:"Confirm network policies allow egress to the collector namespace"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"High trace volume / storage costs:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Reduce ",(0,t.jsx)(n.code,{children:"samplingRatio"})," (e.g., from ",(0,t.jsx)(n.code,{children:"0.1"})," to ",(0,t.jsx)(n.code,{children:"0.01"}),")"]}),"\n",(0,t.jsx)(n.li,{children:"Configure retention in your collector backend"}),"\n",(0,t.jsx)(n.li,{children:"Use tail-based sampling in an OpenTelemetry Collector pipeline for error-biased sampling"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,r){r.d(n,{R:()=>s,x:()=>l});var a=r(6540);const t={},i=a.createContext(t);function s(e){const n=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);