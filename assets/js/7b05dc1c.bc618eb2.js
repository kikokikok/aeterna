"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6938],{5282(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"helm/logging","title":"Log Aggregation with Aeterna","description":"Aeterna outputs structured JSON logs by default. This guide covers integration with Grafana Loki and the ELK stack.","source":"@site/docs/helm/logging.md","sourceDirName":"helm","slug":"/helm/logging","permalink":"/aeterna/docs/helm/logging","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/helm/logging.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Backup Restore Procedure","permalink":"/aeterna/docs/helm/restore"},"next":{"title":"Distributed Tracing with Aeterna","permalink":"/aeterna/docs/helm/tracing"}}');var a=s(4848),r=s(8453);const l={},t="Log Aggregation with Aeterna",o={},c=[{value:"Log Configuration",id:"log-configuration",level:2},{value:"Log Levels",id:"log-levels",level:3},{value:"Per-Component Filtering",id:"per-component-filtering",level:3},{value:"Grafana Loki + Promtail",id:"grafana-loki--promtail",level:2},{value:"Deploy Loki Stack",id:"deploy-loki-stack",level:3},{value:"Deploy Promtail",id:"deploy-promtail",level:3},{value:"Grafana Data Source",id:"grafana-data-source",level:3},{value:"Useful LogQL Queries",id:"useful-logql-queries",level:3},{value:"ELK Stack (Elasticsearch + Logstash + Kibana)",id:"elk-stack-elasticsearch--logstash--kibana",level:2},{value:"Deploy with Filebeat",id:"deploy-with-filebeat",level:3},{value:"Index Lifecycle Management",id:"index-lifecycle-management",level:3},{value:"Kibana Dashboard",id:"kibana-dashboard",level:3},{value:"Log Correlation with Traces",id:"log-correlation-with-traces",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"log-aggregation-with-aeterna",children:"Log Aggregation with Aeterna"})}),"\n",(0,a.jsx)(n.p,{children:"Aeterna outputs structured JSON logs by default. This guide covers integration with Grafana Loki and the ELK stack."}),"\n",(0,a.jsx)(n.h2,{id:"log-configuration",children:"Log Configuration"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"observability:\n  logging:\n    level: info    # debug, info, warn, error\n    format: json   # json, pretty\n"})}),"\n",(0,a.jsx)(n.p,{children:"These values control the following environment variables on the Aeterna deployment:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Variable"}),(0,a.jsx)(n.th,{children:"Value"}),(0,a.jsx)(n.th,{children:"Purpose"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"RUST_LOG"})}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"observability.logging.level"})}),(0,a.jsx)(n.td,{children:"Rust log level filter"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"LOG_FORMAT"})}),(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"observability.logging.format"})}),(0,a.jsx)(n.td,{children:"Output format"})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"log-levels",children:"Log Levels"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Level"}),(0,a.jsx)(n.th,{children:"Use Case"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"error"})}),(0,a.jsx)(n.td,{children:"Production \u2014 only errors and panics"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"warn"})}),(0,a.jsx)(n.td,{children:"Production \u2014 includes deprecation warnings"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"info"})}),(0,a.jsx)(n.td,{children:"Default \u2014 request lifecycle, startup, shutdown"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"debug"})}),(0,a.jsx)(n.td,{children:"Development \u2014 internal state, query plans, cache hits"})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"per-component-filtering",children:"Per-Component Filtering"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"RUST_LOG"})," directive supports fine-grained control:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'observability:\n  logging:\n    level: "info,aeterna_memory=debug,aeterna_storage=warn,tower_http=debug"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["This sets the global level to ",(0,a.jsx)(n.code,{children:"info"}),", enables ",(0,a.jsx)(n.code,{children:"debug"})," for memory operations, restricts storage logs to ",(0,a.jsx)(n.code,{children:"warn"}),", and enables HTTP request tracing."]}),"\n",(0,a.jsx)(n.h2,{id:"grafana-loki--promtail",children:"Grafana Loki + Promtail"}),"\n",(0,a.jsx)(n.h3,{id:"deploy-loki-stack",children:"Deploy Loki Stack"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"helm repo add grafana https://grafana.github.io/helm-charts\nhelm repo update\n\nhelm install loki grafana/loki-stack \\\n  --namespace observability --create-namespace \\\n  --set promtail.enabled=true \\\n  --set loki.persistence.enabled=true \\\n  --set loki.persistence.size=50Gi\n"})}),"\n",(0,a.jsx)(n.p,{children:"For production with S3 backend:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"helm install loki grafana/loki \\\n  --namespace observability --create-namespace \\\n  --set loki.storage.type=s3 \\\n  --set loki.storage.s3.bucketnames=aeterna-logs \\\n  --set loki.storage.s3.endpoint=s3.amazonaws.com \\\n  --set loki.storage.s3.region=us-east-1 \\\n  --set loki.storage.s3.insecure=false \\\n  --set loki.compactor.retention_enabled=true \\\n  --set loki.limits_config.retention_period=720h\n"})}),"\n",(0,a.jsx)(n.h3,{id:"deploy-promtail",children:"Deploy Promtail"}),"\n",(0,a.jsx)(n.p,{children:"Promtail runs as a DaemonSet and ships pod logs to Loki automatically. No Aeterna-specific configuration is required \u2014 Promtail discovers pods via Kubernetes labels."}),"\n",(0,a.jsx)(n.p,{children:"Verify Promtail is collecting Aeterna logs:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kubectl logs -l app.kubernetes.io/name=promtail -n observability | grep aeterna\n"})}),"\n",(0,a.jsx)(n.h3,{id:"grafana-data-source",children:"Grafana Data Source"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: 1\ndatasources:\n  - name: Loki\n    type: loki\n    access: proxy\n    url: http://loki.observability.svc:3100\n    jsonData:\n      derivedFields:\n        - datasourceUid: tempo\n          matcherRegex: \'"trace_id":"(\\w+)"\'\n          name: TraceID\n          url: "$${__value.raw}"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"useful-logql-queries",children:"Useful LogQL Queries"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-logql",children:'# All Aeterna error logs\n{app="aeterna"} |= "ERROR"\n\n# Memory operations slower than 100ms\n{app="aeterna"} | json | duration > 100ms | component = "memory"\n\n# Failed authorization decisions\n{app="aeterna"} | json | msg =~ "authorization.*denied"\n\n# Request rate by endpoint\nsum(rate({app="aeterna"} | json | __error__="" [5m])) by (path)\n'})}),"\n",(0,a.jsx)(n.h2,{id:"elk-stack-elasticsearch--logstash--kibana",children:"ELK Stack (Elasticsearch + Logstash + Kibana)"}),"\n",(0,a.jsx)(n.h3,{id:"deploy-with-filebeat",children:"Deploy with Filebeat"}),"\n",(0,a.jsx)(n.p,{children:"Filebeat collects logs from Kubernetes pods and ships them to Elasticsearch."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'helm repo add elastic https://helm.elastic.co\nhelm repo update\n\nhelm install elasticsearch elastic/elasticsearch \\\n  --namespace observability --create-namespace \\\n  --set replicas=3 \\\n  --set minimumMasterNodes=2 \\\n  --set volumeClaimTemplate.resources.requests.storage=100Gi\n\nhelm install kibana elastic/kibana \\\n  --namespace observability\n\nhelm install filebeat elastic/filebeat \\\n  --namespace observability \\\n  --set daemonset.filebeatConfig.filebeat\\.yml="$(cat <<\'EOF\'\nfilebeat.autodiscover:\n  providers:\n    - type: kubernetes\n      node: ${NODE_NAME}\n      hints.enabled: true\n      hints.default_config:\n        type: container\n        paths:\n          - /var/log/containers/*${data.kubernetes.container.id}.log\nprocessors:\n  - decode_json_fields:\n      fields: ["message"]\n      process_array: false\n      max_depth: 3\n      target: ""\n      overwrite_keys: true\n  - add_kubernetes_metadata:\n      host: ${NODE_NAME}\n      matchers:\n        - logs_path:\n            logs_path: "/var/log/containers/"\noutput.elasticsearch:\n  hosts: ["http://elasticsearch-master.observability.svc:9200"]\n  index: "aeterna-logs-%{+yyyy.MM.dd}"\nsetup.ilm.enabled: true\nsetup.ilm.rollover_alias: "aeterna-logs"\nsetup.ilm.policy_name: "aeterna-logs-policy"\nEOF\n)"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"index-lifecycle-management",children:"Index Lifecycle Management"}),"\n",(0,a.jsx)(n.p,{children:"Create an ILM policy for log retention:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'PUT _ilm/policy/aeterna-logs-policy\n{\n  "policy": {\n    "phases": {\n      "hot": {\n        "min_age": "0ms",\n        "actions": {\n          "rollover": {\n            "max_age": "1d",\n            "max_primary_shard_size": "50gb"\n          }\n        }\n      },\n      "warm": {\n        "min_age": "7d",\n        "actions": {\n          "shrink": { "number_of_shards": 1 },\n          "forcemerge": { "max_num_segments": 1 }\n        }\n      },\n      "delete": {\n        "min_age": "30d",\n        "actions": { "delete": {} }\n      }\n    }\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"kibana-dashboard",children:"Kibana Dashboard"}),"\n",(0,a.jsx)(n.p,{children:"Create a saved search for Aeterna logs:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Open Kibana \u2192 Discover"}),"\n",(0,a.jsxs)(n.li,{children:["Create index pattern ",(0,a.jsx)(n.code,{children:"aeterna-logs-*"})]}),"\n",(0,a.jsxs)(n.li,{children:["Filter by ",(0,a.jsx)(n.code,{children:"kubernetes.labels.app_kubernetes_io/name: aeterna"})]}),"\n",(0,a.jsxs)(n.li,{children:["Pin useful columns: ",(0,a.jsx)(n.code,{children:"level"}),", ",(0,a.jsx)(n.code,{children:"msg"}),", ",(0,a.jsx)(n.code,{children:"component"}),", ",(0,a.jsx)(n.code,{children:"duration"}),", ",(0,a.jsx)(n.code,{children:"trace_id"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"log-correlation-with-traces",children:"Log Correlation with Traces"}),"\n",(0,a.jsxs)(n.p,{children:["Aeterna includes ",(0,a.jsx)(n.code,{children:"trace_id"})," and ",(0,a.jsx)(n.code,{children:"span_id"})," in structured log entries when tracing is enabled. Use these fields to jump between logs and traces:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-json",children:'{\n  "timestamp": "2026-01-15T10:30:00.123Z",\n  "level": "INFO",\n  "msg": "memory_search completed",\n  "component": "memory",\n  "duration_ms": 42,\n  "trace_id": "abc123def456",\n  "span_id": "789012345678",\n  "query": "database selection",\n  "results": 5\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In Grafana, configure derived fields on the Loki data source to link ",(0,a.jsx)(n.code,{children:"trace_id"})," values to Tempo. In Kibana, create a scripted field that links to the Jaeger UI."]}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Logs not appearing in Loki/Elasticsearch:"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Verify Promtail/Filebeat DaemonSet is running on the Aeterna node"}),"\n",(0,a.jsxs)(n.li,{children:["Check log format: ",(0,a.jsx)(n.code,{children:"kubectl logs <aeterna-pod> | head -1"})," should show JSON"]}),"\n",(0,a.jsxs)(n.li,{children:["Verify labels: ",(0,a.jsx)(n.code,{children:"kubectl get pod <aeterna-pod> --show-labels"})]}),"\n",(0,a.jsx)(n.li,{children:"Check Promtail/Filebeat logs for ingestion errors"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"JSON parsing failures:"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Ensure ",(0,a.jsx)(n.code,{children:"observability.logging.format"})," is set to ",(0,a.jsx)(n.code,{children:"json"})," (not ",(0,a.jsx)(n.code,{children:"pretty"}),")"]}),"\n",(0,a.jsx)(n.li,{children:"Check for multi-line log entries that break JSON parsing"}),"\n",(0,a.jsxs)(n.li,{children:["Verify Filebeat ",(0,a.jsx)(n.code,{children:"decode_json_fields"})," processor is configured"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"High log volume:"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Increase log level to ",(0,a.jsx)(n.code,{children:"warn"})," or ",(0,a.jsx)(n.code,{children:"error"})," in production"]}),"\n",(0,a.jsx)(n.li,{children:"Use per-component filtering to silence noisy modules"}),"\n",(0,a.jsx)(n.li,{children:"Configure retention policies in your log backend"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>l,x:()=>t});var i=s(6540);const a={},r=i.createContext(a);function l(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);