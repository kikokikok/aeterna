"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[8119],{193(e,r,s){s.r(r),s.d(r,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>n,toc:()=>a});const n=JSON.parse('{"id":"guides/disaster-recovery-runbook","title":"Disaster Recovery Runbook","description":"Overview","source":"@site/docs/guides/disaster-recovery-runbook.md","sourceDirName":"guides","slug":"/guides/disaster-recovery-runbook","permalink":"/aeterna/docs/guides/disaster-recovery-runbook","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/guides/disaster-recovery-runbook.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"High Availability Deployment Guide","permalink":"/aeterna/docs/guides/ha-deployment"},"next":{"title":"Observability Runbook","permalink":"/aeterna/docs/guides/observability-runbook"}}');var t=s(4848),i=s(8453);const l={},o="Disaster Recovery Runbook",c={},a=[{value:"Overview",id:"overview",level:2},{value:"Recovery Time &amp; Point Objectives (RTO/RPO)",id:"recovery-time--point-objectives-rtorpo",level:2},{value:"Component Recovery Procedures",id:"component-recovery-procedures",level:2},{value:"1. PostgreSQL (Metadata)",id:"1-postgresql-metadata",level:3},{value:"2. Qdrant (Vector Storage)",id:"2-qdrant-vector-storage",level:3},{value:"3. Redis (Cache &amp; Pub/Sub)",id:"3-redis-cache--pubsub",level:3},{value:"DR Drill Schedule",id:"dr-drill-schedule",level:2},{value:"Post-Mortem Template",id:"post-mortem-template",level:2}];function d(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"disaster-recovery-runbook",children:"Disaster Recovery Runbook"})}),"\n",(0,t.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(r.p,{children:"This runbook outlines the procedures for recovering the Aeterna platform from critical failures."}),"\n",(0,t.jsx)(r.h2,{id:"recovery-time--point-objectives-rtorpo",children:"Recovery Time & Point Objectives (RTO/RPO)"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"RTO (Recovery Time Objective)"}),": 15 minutes."]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"RPO (Recovery Point Objective)"}),": 5 minutes."]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"component-recovery-procedures",children:"Component Recovery Procedures"}),"\n",(0,t.jsx)(r.h3,{id:"1-postgresql-metadata",children:"1. PostgreSQL (Metadata)"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"RTO Target"}),": 5 minutes."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Detection Method"}),":"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Patroni reports no healthy primary."}),"\n",(0,t.jsxs)(r.li,{children:["Prometheus ",(0,t.jsx)(r.code,{children:"up"})," metric for PostgreSQL instances is 0."]}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Automated vs Manual Failover"}),":"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Automated"}),": Patroni automatically elects a new primary from healthy replicas."]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Manual"}),": Trigger a manual switchover if the automated failover is stuck."]}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Restore Steps"}),":"]}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Run the backup script: ",(0,t.jsx)(r.code,{children:"infrastructure/ha/backups/backup-postgres.sh"}),"."]}),"\n",(0,t.jsxs)(r.li,{children:["To restore from a WAL-G or PGBackRest backup:\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"# Restore from the latest base backup and replay WALs\nkubectl exec -it patroni-postgresql-0 -- pg_restore -d aeterna /backups/latest.dump\n"})}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["Verify data integrity using the restore test script:\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"bash infrastructure/ha/backups/restore-test.sh postgres\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.h3,{id:"2-qdrant-vector-storage",children:"2. Qdrant (Vector Storage)"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"RTO Target"}),": 10 minutes."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Detection Method"}),":"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Qdrant API returns 503 Service Unavailable."}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"aeterna_qdrant_cluster_status"}),' is "Red".']}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Automated vs Manual Failover"}),":"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Automated"}),": Qdrant cluster replicates data across nodes. If one node fails, others serve the traffic."]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Manual"}),": Replace the failed node and trigger a shard redistribution."]}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Restore Steps"}),":"]}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Run the Qdrant backup script: ",(0,t.jsx)(r.code,{children:"infrastructure/ha/backups/backup-qdrant.sh"}),"."]}),"\n",(0,t.jsxs)(r.li,{children:["Restore from a collection snapshot:\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"curl -X POST http://qdrant:6333/collections/{collection_name}/snapshots/recover \\\n  -H 'Content-Type: application/json' \\\n  --data '{\"location\": \"http://backup-server/snapshots/latest.snapshot\"}'\n"})}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["Test connectivity and search relevance:\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"bash infrastructure/ha/backups/restore-test.sh qdrant\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.h3,{id:"3-redis-cache--pubsub",children:"3. Redis (Cache & Pub/Sub)"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"RTO Target"}),": 2 minutes."]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Detection Method"}),":"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Redis Sentinel reports ODown (Objective Down) for the master."}),"\n",(0,t.jsx)(r.li,{children:"Memory operations dashboard shows 100% cache miss rate."}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Automated vs Manual Failover"}),":"]}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Automated"}),": Redis Sentinel promotes a replica to master and reconfigures others."]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Manual"}),": Manually promote a replica if Sentinels fail to reach quorum."]}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"Restore Steps"}),":"]}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Run the Redis backup script: ",(0,t.jsx)(r.code,{children:"infrastructure/ha/backups/backup-redis.sh"}),"."]}),"\n",(0,t.jsxs)(r.li,{children:["If the persistent store (AOF/RDB) is corrupted:\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"# Replace the dump.rdb with the latest backup\ncp /backups/redis/latest.rdb /data/dump.rdb\nkubectl delete pod redis-master-0\n"})}),"\n"]}),"\n",(0,t.jsxs)(r.li,{children:["Verify cache health:\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-bash",children:"bash infrastructure/ha/backups/restore-test.sh redis\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"dr-drill-schedule",children:"DR Drill Schedule"}),"\n",(0,t.jsx)(r.p,{children:"To ensure the effectiveness of these procedures, Aeterna teams must perform quarterly DR drills."}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Quarter"}),(0,t.jsx)(r.th,{children:"Drill Type"}),(0,t.jsx)(r.th,{children:"Scope"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Q1"}),(0,t.jsx)(r.td,{children:"Primary Failover"}),(0,t.jsx)(r.td,{children:"PostgreSQL (Patroni) + Redis (Sentinel)"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Q2"}),(0,t.jsx)(r.td,{children:"Regional Outage"}),(0,t.jsx)(r.td,{children:"Full site failover to a secondary AZ"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Q3"}),(0,t.jsx)(r.td,{children:"Data Corruption"}),(0,t.jsx)(r.td,{children:"Restore from snapshots + WAL replay"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Q4"}),(0,t.jsx)(r.td,{children:"Resource Exhaustion"}),(0,t.jsx)(r.td,{children:"Scale-up and shard redistribution"})]})]})]}),"\n",(0,t.jsx)(r.h2,{id:"post-mortem-template",children:"Post-Mortem Template"}),"\n",(0,t.jsx)(r.p,{children:"After every incident or drill, complete a post-mortem report:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Timeline"}),": When was the failure detected, when was it resolved?"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Root Cause"}),": What triggered the failure?"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Resolution"}),": Which recovery steps were followed?"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Lessons Learned"}),": How can we improve our RTO/RPO or automated failover?"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Action Items"}),": New tasks to improve system resilience."]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,r,s){s.d(r,{R:()=>l,x:()=>o});var n=s(6540);const t={},i=n.createContext(t);function l(e){const r=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),n.createElement(i.Provider,{value:r},e.children)}}}]);