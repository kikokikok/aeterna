"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[3278],{5443(e,s,n){n.r(s),n.d(s,{assets:()=>i,contentTitle:()=>c,default:()=>o,frontMatter:()=>l,metadata:()=>a,toc:()=>h});const a=JSON.parse('{"id":"helm/sops-secrets","title":"SOPS Secrets Management","description":"Encrypt sensitive Helm values using SOPS and the helm-secrets plugin.","source":"@site/docs/helm/sops-secrets.md","sourceDirName":"helm","slug":"/helm/sops-secrets","permalink":"/aeterna/docs/helm/sops-secrets","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/helm/sops-secrets.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"External Secrets Operator Integration","permalink":"/aeterna/docs/helm/external-secrets"},"next":{"title":"Upgrade Guide","permalink":"/aeterna/docs/helm/upgrade"}}');var t=n(4848),r=n(8453);const l={},c="SOPS Secrets Management",i={},h=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Setup with age Keys",id:"setup-with-age-keys",level:2},{value:"Generate a key pair",id:"generate-a-key-pair",level:3},{value:"Store the private key",id:"store-the-private-key",level:3},{value:"Create <code>.sops.yaml</code> in the project root",id:"create-sopsyaml-in-the-project-root",level:3},{value:"Setup with GPG Keys",id:"setup-with-gpg-keys",level:2},{value:"Generate a GPG key",id:"generate-a-gpg-key",level:3},{value:"Create <code>.sops.yaml</code>",id:"create-sopsyaml",level:3},{value:"Encrypting Values",id:"encrypting-values",level:2},{value:"Deploying with Encrypted Values",id:"deploying-with-encrypted-values",level:2},{value:"Editing Encrypted Files",id:"editing-encrypted-files",level:2},{value:"Key Rotation",id:"key-rotation",level:2},{value:"CI/CD Integration",id:"cicd-integration",level:2}];function d(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"sops-secrets-management",children:"SOPS Secrets Management"})}),"\n",(0,t.jsxs)(s.p,{children:["Encrypt sensitive Helm values using ",(0,t.jsx)(s.a,{href:"https://github.com/getsops/sops",children:"SOPS"})," and the ",(0,t.jsx)(s.a,{href:"https://github.com/jkroepke/helm-secrets",children:"helm-secrets"})," plugin."]}),"\n",(0,t.jsx)(s.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/getsops/sops/releases",children:"SOPS"})," v3.8+"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/jkroepke/helm-secrets",children:"helm-secrets"})," plugin"]}),"\n",(0,t.jsx)(s.li,{children:"An encryption key (age or GPG)"}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm plugin install https://github.com/jkroepke/helm-secrets\n"})}),"\n",(0,t.jsx)(s.h2,{id:"setup-with-age-keys",children:"Setup with age Keys"}),"\n",(0,t.jsx)(s.h3,{id:"generate-a-key-pair",children:"Generate a key pair"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"age-keygen -o age-key.txt\n# Public key: age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p\n"})}),"\n",(0,t.jsx)(s.h3,{id:"store-the-private-key",children:"Store the private key"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"mkdir -p ~/.config/sops/age\ncp age-key.txt ~/.config/sops/age/keys.txt\n"})}),"\n",(0,t.jsxs)(s.h3,{id:"create-sopsyaml-in-the-project-root",children:["Create ",(0,t.jsx)(s.code,{children:".sops.yaml"})," in the project root"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'creation_rules:\n  - path_regex: charts/aeterna/.*\\.enc\\.yaml$\n    age: "age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"\n'})}),"\n",(0,t.jsx)(s.h2,{id:"setup-with-gpg-keys",children:"Setup with GPG Keys"}),"\n",(0,t.jsx)(s.h3,{id:"generate-a-gpg-key",children:"Generate a GPG key"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"gpg --full-generate-key\n# Note the fingerprint, e.g. 1234ABCD5678EFGH\n"})}),"\n",(0,t.jsxs)(s.h3,{id:"create-sopsyaml",children:["Create ",(0,t.jsx)(s.code,{children:".sops.yaml"})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'creation_rules:\n  - path_regex: charts/aeterna/.*\\.enc\\.yaml$\n    pgp: "1234ABCD5678EFGH"\n'})}),"\n",(0,t.jsx)(s.h2,{id:"encrypting-values",children:"Encrypting Values"}),"\n",(0,t.jsx)(s.p,{children:"Start from the example file:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"cp charts/aeterna/examples/values-sops.yaml charts/aeterna/values-secrets.yaml\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Edit ",(0,t.jsx)(s.code,{children:"values-secrets.yaml"})," with real credentials, then encrypt:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"sops --encrypt charts/aeterna/values-secrets.yaml > charts/aeterna/values-secrets.enc.yaml\nrm charts/aeterna/values-secrets.yaml\n"})}),"\n",(0,t.jsx)(s.h2,{id:"deploying-with-encrypted-values",children:"Deploying with Encrypted Values"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm secrets install aeterna ./charts/aeterna \\\n  -f charts/aeterna/values.yaml \\\n  -f charts/aeterna/values-secrets.enc.yaml\n"})}),"\n",(0,t.jsx)(s.p,{children:"Upgrade:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"helm secrets upgrade aeterna ./charts/aeterna \\\n  -f charts/aeterna/values.yaml \\\n  -f charts/aeterna/values-secrets.enc.yaml\n"})}),"\n",(0,t.jsx)(s.h2,{id:"editing-encrypted-files",children:"Editing Encrypted Files"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"sops charts/aeterna/values-secrets.enc.yaml\n"})}),"\n",(0,t.jsxs)(s.p,{children:["This opens the decrypted content in your ",(0,t.jsx)(s.code,{children:"$EDITOR"}),", then re-encrypts on save."]}),"\n",(0,t.jsx)(s.h2,{id:"key-rotation",children:"Key Rotation"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"sops --rotate --in-place charts/aeterna/values-secrets.enc.yaml\n"})}),"\n",(0,t.jsx)(s.h2,{id:"cicd-integration",children:"CI/CD Integration"}),"\n",(0,t.jsx)(s.p,{children:"Store the age private key or GPG key as a CI secret, then export before running helm:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"export SOPS_AGE_KEY_FILE=/path/to/age-key.txt\nhelm secrets upgrade aeterna ./charts/aeterna -f values-secrets.enc.yaml\n"})}),"\n",(0,t.jsx)(s.p,{children:"For GitHub Actions:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:'- name: Deploy\n  env:\n    SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}\n  run: |\n    echo "$SOPS_AGE_KEY" > /tmp/age-key.txt\n    export SOPS_AGE_KEY_FILE=/tmp/age-key.txt\n    helm secrets upgrade aeterna ./charts/aeterna -f values-secrets.enc.yaml\n'})})]})}function o(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,s,n){n.d(s,{R:()=>l,x:()=>c});var a=n(6540);const t={},r=a.createContext(t);function l(e){const s=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),a.createElement(r.Provider,{value:s},e.children)}}}]);