"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[8887],{6530(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>a,toc:()=>i});const a=JSON.parse('{"id":"helm/restore","title":"Backup Restore Procedure","description":"Prerequisites","source":"@site/docs/helm/restore.md","sourceDirName":"helm","slug":"/helm/restore","permalink":"/aeterna/docs/helm/restore","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/helm/restore.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"CloudNativePG Upgrade Procedure","permalink":"/aeterna/docs/helm/cnpg-upgrade"},"next":{"title":"Log Aggregation with Aeterna","permalink":"/aeterna/docs/helm/logging"}}');var r=s(4848),t=s(8453);const l={},c="Backup Restore Procedure",o={},i=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Locating Backups",id:"locating-backups",level:2},{value:"S3",id:"s3",level:3},{value:"GCS",id:"gcs",level:3},{value:"Azure Blob Storage",id:"azure-blob-storage",level:3},{value:"Download the Backup",id:"download-the-backup",level:2},{value:"Restore to Existing Cluster",id:"restore-to-existing-cluster",level:2},{value:"1. Scale down Aeterna",id:"1-scale-down-aeterna",level:3},{value:"2. Connect to PostgreSQL",id:"2-connect-to-postgresql",level:3},{value:"3. Restore the database",id:"3-restore-the-database",level:3},{value:"4. Scale Aeterna back up",id:"4-scale-aeterna-back-up",level:3},{value:"5. Verify",id:"5-verify",level:3},{value:"Restore to a New Cluster",id:"restore-to-a-new-cluster",level:2},{value:"Backup Verification",id:"backup-verification",level:2},{value:"Qdrant Snapshots",id:"qdrant-snapshots",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"backup-restore-procedure",children:"Backup Restore Procedure"})}),"\n",(0,r.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kubectl"})," access to the cluster"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pg_restore"})," (PostgreSQL 16 client tools)"]}),"\n",(0,r.jsx)(n.li,{children:"Access to the backup storage (S3/GCS/Azure)"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"locating-backups",children:"Locating Backups"}),"\n",(0,r.jsxs)(n.p,{children:["Backups are stored under ",(0,r.jsx)(n.code,{children:"aeterna/<YYYY>/<MM>/<DD>/"})," in your configured destination."]}),"\n",(0,r.jsx)(n.h3,{id:"s3",children:"S3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"aws s3 ls s3://YOUR_BUCKET/aeterna/ --recursive | sort | tail -5\n"})}),"\n",(0,r.jsx)(n.h3,{id:"gcs",children:"GCS"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gsutil ls -r gs://YOUR_BUCKET/aeterna/ | sort | tail -5\n"})}),"\n",(0,r.jsx)(n.h3,{id:"azure-blob-storage",children:"Azure Blob Storage"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"az storage blob list --account-name YOUR_ACCOUNT --container-name YOUR_CONTAINER --prefix aeterna/ --output table\n"})}),"\n",(0,r.jsx)(n.h2,{id:"download-the-backup",children:"Download the Backup"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"aws s3 cp s3://YOUR_BUCKET/aeterna/2026/02/21/backup-20260221-020000.sql /tmp/restore.sql\n"})}),"\n",(0,r.jsx)(n.h2,{id:"restore-to-existing-cluster",children:"Restore to Existing Cluster"}),"\n",(0,r.jsx)(n.h3,{id:"1-scale-down-aeterna",children:"1. Scale down Aeterna"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl scale deployment aeterna --replicas=0\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-connect-to-postgresql",children:"2. Connect to PostgreSQL"}),"\n",(0,r.jsx)(n.p,{children:"For bundled CloudNativePG:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl get secret aeterna-pg-app -o jsonpath='{.data.password}' | base64 -d\nkubectl port-forward svc/aeterna-pg-rw 5432:5432 &\n"})}),"\n",(0,r.jsx)(n.p,{children:"For external PostgreSQL, use your existing connection details."}),"\n",(0,r.jsx)(n.h3,{id:"3-restore-the-database",children:"3. Restore the database"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"pg_restore \\\n  --host=localhost \\\n  --port=5432 \\\n  --username=aeterna \\\n  --dbname=aeterna \\\n  --clean \\\n  --if-exists \\\n  --verbose \\\n  /tmp/restore.sql\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"--clean --if-exists"})," flags drop existing objects before recreating them, making the restore idempotent."]}),"\n",(0,r.jsx)(n.h3,{id:"4-scale-aeterna-back-up",children:"4. Scale Aeterna back up"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl scale deployment aeterna --replicas=2\n"})}),"\n",(0,r.jsx)(n.h3,{id:"5-verify",children:"5. Verify"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl port-forward svc/aeterna 8080:8080 &\ncurl http://localhost:8080/health/ready\n"})}),"\n",(0,r.jsx)(n.h2,{id:"restore-to-a-new-cluster",children:"Restore to a New Cluster"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Install Aeterna with the same ",(0,r.jsx)(n.code,{children:"values.yaml"})," configuration"]}),"\n",(0,r.jsx)(n.li,{children:"Wait for the migration job to complete (creates the schema)"}),"\n",(0,r.jsxs)(n.li,{children:["Scale down Aeterna: ",(0,r.jsx)(n.code,{children:"kubectl scale deployment aeterna --replicas=0"})]}),"\n",(0,r.jsx)(n.li,{children:"Restore the backup (steps 2-3 above)"}),"\n",(0,r.jsx)(n.li,{children:"Scale back up"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"backup-verification",children:"Backup Verification"}),"\n",(0,r.jsx)(n.p,{children:"Enable the verification CronJob to automatically validate backup integrity:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'backup:\n  enabled: true\n  verify:\n    enabled: true\n    schedule: "0 6 * * *"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The verify job downloads the latest backup, runs ",(0,r.jsx)(n.code,{children:"pg_restore --list"})," to check integrity, and exits non-zero on corruption."]}),"\n",(0,r.jsx)(n.p,{children:"Check verification results:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kubectl get jobs -l app.kubernetes.io/component=backup-verify\nkubectl logs job/aeterna-backup-verify-<timestamp>\n"})}),"\n",(0,r.jsx)(n.h2,{id:"qdrant-snapshots",children:"Qdrant Snapshots"}),"\n",(0,r.jsx)(n.p,{children:"For Qdrant vector data, snapshots are managed separately:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'qdrant:\n  snapshots:\n    enabled: true\n    schedule: "0 3 * * *"\n    destination: "s3://YOUR_BUCKET/qdrant-snapshots"\n'})}),"\n",(0,r.jsx)(n.p,{children:"Restore Qdrant snapshots via the Qdrant API:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'curl -X POST "http://qdrant:6333/collections/aeterna/snapshots/upload" \\\n  -H "Content-Type: multipart/form-data" \\\n  -F "snapshot=@/path/to/snapshot.tar"\n'})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>l,x:()=>c});var a=s(6540);const r={},t=a.createContext(r);function l(e){const n=a.useContext(t);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);