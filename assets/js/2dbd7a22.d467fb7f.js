"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[9775],{2061(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"security/tenant-isolation-testing","title":"Tenant Isolation Penetration Testing","description":"Overview","source":"@site/docs/security/tenant-isolation-testing.md","sourceDirName":"security","slug":"/security/tenant-isolation-testing","permalink":"/aeterna/docs/security/tenant-isolation-testing","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/security/tenant-isolation-testing.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"RBAC Testing Procedures","permalink":"/aeterna/docs/security/rbac-testing-procedures"},"next":{"title":"GDPR Compliance Procedures","permalink":"/aeterna/docs/guides/gdpr-procedures"}}');var i=t(4848),r=t(8453);const d={},l="Tenant Isolation Penetration Testing",c={},o=[{value:"Overview",id:"overview",level:2},{value:"Test Categories",id:"test-categories",level:2},{value:"1. Cross-Tenant Access Tests",id:"1-cross-tenant-access-tests",level:3},{value:"2. SQL Injection Tests",id:"2-sql-injection-tests",level:3},{value:"3. Tenant ID Validation Tests",id:"3-tenant-id-validation-tests",level:3},{value:"4. RLS Policy Tests",id:"4-rls-policy-tests",level:3},{value:"Running Tests",id:"running-tests",level:2},{value:"Test Result Format",id:"test-result-format",level:2},{value:"Protected Tables",id:"protected-tables",level:2},{value:"Query Builder Protection",id:"query-builder-protection",level:2},{value:"Adding New Tests",id:"adding-new-tests",level:2},{value:"CI Integration",id:"ci-integration",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"tenant-isolation-penetration-testing",children:"Tenant Isolation Penetration Testing"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"This document describes procedures for testing tenant data isolation in Aeterna's multi-tenant architecture."}),"\n",(0,i.jsx)(n.h2,{id:"test-categories",children:"Test Categories"}),"\n",(0,i.jsx)(n.h3,{id:"1-cross-tenant-access-tests",children:"1. Cross-Tenant Access Tests"}),"\n",(0,i.jsxs)(n.p,{children:["Location: ",(0,i.jsx)(n.code,{children:"storage/tests/tenant_isolation_test.rs"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Test"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Attack Vector"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_isolation_cross_tenant_node_access"})}),(0,i.jsx)(n.td,{children:"Verify tenant B cannot see tenant A's nodes"}),(0,i.jsx)(n.td,{children:"Direct access attempt"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_isolation_cross_tenant_edge_creation_blocked"})}),(0,i.jsx)(n.td,{children:"Verify edges cannot span tenants"}),(0,i.jsx)(n.td,{children:"Relationship bypass"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_isolation_find_related_cross_tenant"})}),(0,i.jsx)(n.td,{children:"Verify graph traversal respects boundaries"}),(0,i.jsx)(n.td,{children:"Transitive access"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_isolation_stats_per_tenant"})}),(0,i.jsx)(n.td,{children:"Verify stats scoped to tenant"}),(0,i.jsx)(n.td,{children:"Information disclosure"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"2-sql-injection-tests",children:"2. SQL Injection Tests"}),"\n",(0,i.jsxs)(n.p,{children:["Location: ",(0,i.jsx)(n.code,{children:"storage/tests/tenant_isolation_test.rs"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Test"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Payload"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_id_validation_sql_injection_single_quote"})}),(0,i.jsx)(n.td,{children:"Single quote injection"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tenant'; DROP TABLE"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_id_validation_sql_injection_double_dash"})}),(0,i.jsx)(n.td,{children:"Comment injection"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tenant--comment"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_id_validation_sql_injection_union"})}),(0,i.jsx)(n.td,{children:"UNION SELECT injection"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tenantUNIONSELECT"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_id_validation_sql_injection_semicolon"})}),(0,i.jsx)(n.td,{children:"Statement termination"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tenant;DELETE"})})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"3-tenant-id-validation-tests",children:"3. Tenant ID Validation Tests"}),"\n",(0,i.jsxs)(n.p,{children:["Location: ",(0,i.jsx)(n.code,{children:"storage/tests/tenant_isolation_test.rs"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Test"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Validation"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_id_validation_empty"})}),(0,i.jsx)(n.td,{children:"Empty string rejected"}),(0,i.jsx)(n.td,{children:"Length validation"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_id_validation_too_long"})}),(0,i.jsx)(n.td,{children:">100 chars rejected"}),(0,i.jsx)(n.td,{children:"Max length"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_id_validation_valid_patterns"})}),(0,i.jsx)(n.td,{children:"Valid IDs accepted"}),(0,i.jsx)(n.td,{children:"Allowlist patterns"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"4-rls-policy-tests",children:"4. RLS Policy Tests"}),"\n",(0,i.jsxs)(n.p,{children:["Location: ",(0,i.jsx)(n.code,{children:"storage/tests/rls_policy_test.rs"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Test"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Target"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_tenant_context_isolation"})}),(0,i.jsx)(n.td,{children:"Contexts are independent"}),(0,i.jsx)(n.td,{children:"TenantContext"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"test_rls_cross_tenant_access_blocked"})}),(0,i.jsx)(n.td,{children:"Database-level RLS"}),(0,i.jsx)(n.td,{children:"PostgreSQL policies"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"running-tests",children:"Running Tests"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cargo test -p storage --test tenant_isolation_test\ncargo test -p storage --test rls_policy_test\n\ncargo test -p storage -- --ignored\n"})}),"\n",(0,i.jsx)(n.h2,{id:"test-result-format",children:"Test Result Format"}),"\n",(0,i.jsx)(n.p,{children:"Pass criteria:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"All cross-tenant access attempts return empty results or errors"}),"\n",(0,i.jsx)(n.li,{children:"All SQL injection attempts are rejected at TenantId validation"}),"\n",(0,i.jsx)(n.li,{children:"All tenant ID boundary conditions are enforced"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Failure indicators:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"TenantViolation"})," error not returned on cross-tenant access"]}),"\n",(0,i.jsx)(n.li,{children:"SQL injection payload reaches database layer"}),"\n",(0,i.jsx)(n.li,{children:"Data leak across tenant boundaries"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"protected-tables",children:"Protected Tables"}),"\n",(0,i.jsx)(n.p,{children:"RLS policies are applied to:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Table"}),(0,i.jsx)(n.th,{children:"Policy Name"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sync_states"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sync_states_tenant_isolation"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"memory_entries"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"memory_entries_tenant_isolation"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"knowledge_items"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"knowledge_items_tenant_isolation"})})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"query-builder-protection",children:"Query Builder Protection"}),"\n",(0,i.jsxs)(n.p,{children:["All SQL queries MUST use ",(0,i.jsx)(n.code,{children:"TenantQueryBuilder"})," from ",(0,i.jsx)(n.code,{children:"storage/src/query_builder.rs"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'let builder = TenantQueryBuilder::new(&pool, &tenant_context);\nlet rows = builder\n    .select("*")\n    .from("memory_entries")\n    .fetch_all()\n    .await?;\n'})}),"\n",(0,i.jsx)(n.p,{children:"The builder automatically:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Requires ",(0,i.jsx)(n.code,{children:"TenantContext"})," at construction"]}),"\n",(0,i.jsxs)(n.li,{children:["Adds ",(0,i.jsx)(n.code,{children:"tenant_id = $1"})," to all WHERE clauses"]}),"\n",(0,i.jsx)(n.li,{children:"Binds tenant_id as first parameter"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"adding-new-tests",children:"Adding New Tests"}),"\n",(0,i.jsx)(n.p,{children:"When adding tenant-scoped tables:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Add RLS policy in ",(0,i.jsx)(n.code,{children:"storage/migrations/004_enable_rls.sql"})]}),"\n",(0,i.jsxs)(n.li,{children:["Add table to ",(0,i.jsx)(n.code,{children:"TENANT_TABLES"})," in ",(0,i.jsx)(n.code,{children:"storage/src/rls_migration.rs"})]}),"\n",(0,i.jsxs)(n.li,{children:["Add cross-tenant access test in ",(0,i.jsx)(n.code,{children:"tenant_isolation_test.rs"})]}),"\n",(0,i.jsxs)(n.li,{children:["Verify ",(0,i.jsx)(n.code,{children:"TenantQueryBuilder"})," is used for all queries"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"ci-integration",children:"CI Integration"}),"\n",(0,i.jsxs)(n.p,{children:["Tenant isolation tests run in CI via ",(0,i.jsx)(n.code,{children:".github/workflows/tenant-isolation.yml"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Triggered on all PRs modifying ",(0,i.jsx)(n.code,{children:"storage/"})," or ",(0,i.jsx)(n.code,{children:"mk_core/"})]}),"\n",(0,i.jsx)(n.li,{children:"Requires all tests pass before merge"}),"\n",(0,i.jsx)(n.li,{children:"Runs against PostgreSQL 16 with RLS enabled"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453(e,n,t){t.d(n,{R:()=>d,x:()=>l});var s=t(6540);const i={},r=s.createContext(i);function d(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);