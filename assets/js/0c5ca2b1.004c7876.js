"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6370],{2416(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"specs/memory-system","title":"Memory System Specification","description":"This document specifies the Memory System component: a hierarchical, provider-agnostic semantic memory store for AI agents.","source":"@site/docs/specs/02-memory-system.md","sourceDirName":"specs","slug":"/specs/memory-system","permalink":"/aeterna/docs/specs/memory-system","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/specs/02-memory-system.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Memory System Specification","status":"draft","version":"0.1.0","created":"2025-01-07T00:00:00.000Z","authors":["AI Systems Architecture Team"],"related":["01-core-concepts.md","04-memory-knowledge-sync.md","05-adapter-architecture.md"]},"sidebar":"docs","previous":{"title":"Aeterna: Comprehensive UX/DX Guide","permalink":"/aeterna/docs/comprehensive-ux-dx-guide"},"next":{"title":"Knowledge Repository Specification","permalink":"/aeterna/docs/specs/knowledge-repository"}}');var t=r(4848),s=r(8453);const d={title:"Memory System Specification",status:"draft",version:"0.1.0",created:new Date("2025-01-07T00:00:00.000Z"),authors:["AI Systems Architecture Team"],related:["01-core-concepts.md","04-memory-knowledge-sync.md","05-adapter-architecture.md"]},l="Memory System Specification",o={},a=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Overview",id:"overview",level:2},{value:"Layer Hierarchy",id:"layer-hierarchy",level:2},{value:"The Seven Layers",id:"the-seven-layers",level:3},{value:"Layer Identifiers",id:"layer-identifiers",level:3},{value:"Layer Requirements Matrix",id:"layer-requirements-matrix",level:3},{value:"Memory Entry Schema",id:"memory-entry-schema",level:2},{value:"Core Schema",id:"core-schema",level:3},{value:"Metadata Schema",id:"metadata-schema",level:3},{value:"Example Memory Entries",id:"example-memory-entries",level:3},{value:"Agent-Level Memory",id:"agent-level-memory",level:4},{value:"Project-Level Memory (Knowledge Pointer)",id:"project-level-memory-knowledge-pointer",level:4},{value:"Core Operations",id:"core-operations",level:2},{value:"Operation: Add Memory",id:"operation-add-memory",level:3},{value:"Operation: Search Memory",id:"operation-search-memory",level:3},{value:"Operation: Get Memory",id:"operation-get-memory",level:3},{value:"Operation: Update Memory",id:"operation-update-memory",level:3},{value:"Operation: Delete Memory",id:"operation-delete-memory",level:3},{value:"Operation: List Memories",id:"operation-list-memories",level:3},{value:"Layer Resolution",id:"layer-resolution",level:2},{value:"Precedence Rules",id:"precedence-rules",level:3},{value:"Merge Algorithm",id:"merge-algorithm",level:3},{value:"Override Behavior",id:"override-behavior",level:3},{value:"Layer Access Control",id:"layer-access-control",level:3},{value:"Provider Adapter Interface",id:"provider-adapter-interface",level:2},{value:"Interface Definition",id:"interface-definition",level:3},{value:"Layer Isolation",id:"layer-isolation",level:3},{value:"Strategy 1: Namespace by Layer",id:"strategy-1-namespace-by-layer",level:4},{value:"Strategy 2: Metadata Filtering",id:"strategy-2-metadata-filtering",level:4},{value:"Strategy 3: Tenant Partitioning",id:"strategy-3-tenant-partitioning",level:4},{value:"Memory Lifecycle",id:"memory-lifecycle",level:2},{value:"State Diagram",id:"state-diagram",level:3},{value:"Memory Decay (Optional)",id:"memory-decay-optional",level:3},{value:"Memory Consolidation (Optional)",id:"memory-consolidation-optional",level:3},{value:"Session Memory Cleanup",id:"session-memory-cleanup",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Error Response Format",id:"error-response-format",level:3},{value:"Error Handling Guidelines",id:"error-handling-guidelines",level:3},{value:"Retry Strategy",id:"retry-strategy",level:3},{value:"Implementation Notes",id:"implementation-notes",level:2},{value:"Thread Safety",id:"thread-safety",level:3},{value:"Caching",id:"caching",level:3},{value:"Observability",id:"observability",level:3}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"memory-system-specification",children:"Memory System Specification"})}),"\n",(0,t.jsx)(n.p,{children:"This document specifies the Memory System component: a hierarchical, provider-agnostic semantic memory store for AI agents."}),"\n",(0,t.jsx)(n.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#overview",children:"Overview"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#layer-hierarchy",children:"Layer Hierarchy"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#memory-entry-schema",children:"Memory Entry Schema"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#core-operations",children:"Core Operations"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#layer-resolution",children:"Layer Resolution"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#provider-adapter-interface",children:"Provider Adapter Interface"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#memory-lifecycle",children:"Memory Lifecycle"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#error-handling",children:"Error Handling"})}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"The Memory System provides:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Semantic storage"}),": Vector-based content for similarity search"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Hierarchical scoping"}),": 7 layers from agent-specific to organization-wide"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Provider abstraction"}),": Swap backends without code changes"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Flexible retrieval"}),": Query across layers with precedence rules"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      MEMORY SYSTEM                               \u2502\n\u2502                                                                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502                   Memory Manager                         \u2502    \u2502\n\u2502  \u2502  \u2022 Coordinates all memory operations                     \u2502    \u2502\n\u2502  \u2502  \u2022 Enforces layer rules                                  \u2502    \u2502\n\u2502  \u2502  \u2022 Routes to provider adapter                            \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                              \u2502                                   \u2502\n\u2502                              \u25bc                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502                   Layer Resolver                         \u2502    \u2502\n\u2502  \u2502  \u2022 Determines target layers for operations               \u2502    \u2502\n\u2502  \u2502  \u2022 Applies precedence rules                              \u2502    \u2502\n\u2502  \u2502  \u2022 Merges results from multiple layers                   \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                              \u2502                                   \u2502\n\u2502                              \u25bc                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502                  Provider Adapter                        \u2502    \u2502\n\u2502  \u2502  \u2022 Translates to provider-specific API                   \u2502    \u2502\n\u2502  \u2502  \u2022 Handles connection, auth, retries                     \u2502    \u2502\n\u2502  \u2502  \u2022 Manages embedding generation                          \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                              \u2502                                   \u2502\n\u2502                              \u25bc                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502              Provider (Mem0, Letta, etc.)                \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"layer-hierarchy",children:"Layer Hierarchy"}),"\n",(0,t.jsx)(n.h3,{id:"the-seven-layers",children:"The Seven Layers"}),"\n",(0,t.jsx)(n.p,{children:"Memory is organized into seven hierarchical layers, from most specific to least specific:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                                  \u2502\n\u2502  LAYER          SCOPE                    EXAMPLES                \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502                                                                  \u2502\n\u2502  agent    \u2190\u2500\u2500 Per-agent instance         Agent-specific learnings\u2502\n\u2502    \u2502          (most specific)            Tool preferences        \u2502\n\u2502    \u2502                                                             \u2502\n\u2502  user          Per-user                  User preferences        \u2502\n\u2502    \u2502                                     Communication style     \u2502\n\u2502    \u2502                                                             \u2502\n\u2502  session       Per-session               Current task context    \u2502\n\u2502    \u2502           (conversation)            Recent decisions        \u2502\n\u2502    \u2502                                                             \u2502\n\u2502  project       Per-project/repo          Project conventions     \u2502\n\u2502    \u2502                                     Tech stack choices      \u2502\n\u2502    \u2502                                                             \u2502\n\u2502  team          Per-team                  Team standards          \u2502\n\u2502    \u2502                                     Shared knowledge        \u2502\n\u2502    \u2502                                                             \u2502\n\u2502  org           Per-organization          Org-wide policies       \u2502\n\u2502    \u2502                                     Compliance rules        \u2502\n\u2502    \u2502                                                             \u2502\n\u2502  company  \u2190\u2500\u2500 Per-company/tenant         Company standards       \u2502\n\u2502               (least specific)           Global policies         \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.h3,{id:"layer-identifiers",children:"Layer Identifiers"}),"\n",(0,t.jsx)(n.p,{children:"Each layer requires specific identifiers to scope memory:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface LayerIdentifiers {\n  /** Required for agent layer */\n  agentId?: string;\n  \n  /** Required for user layer and below */\n  userId?: string;\n  \n  /** Required for session layer and below */\n  sessionId?: string;\n  \n  /** Required for project layer and below */\n  projectId?: string;\n  \n  /** Required for team layer and below */\n  teamId?: string;\n  \n  /** Required for org layer and below */\n  orgId?: string;\n  \n  /** Required for company layer */\n  companyId?: string;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"layer-requirements-matrix",children:"Layer Requirements Matrix"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Layer"}),(0,t.jsx)(n.th,{children:"agentId"}),(0,t.jsx)(n.th,{children:"userId"}),(0,t.jsx)(n.th,{children:"sessionId"}),(0,t.jsx)(n.th,{children:"projectId"}),(0,t.jsx)(n.th,{children:"teamId"}),(0,t.jsx)(n.th,{children:"orgId"}),(0,t.jsx)(n.th,{children:"companyId"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"agent"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"user"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"session"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"project"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"team"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"org"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"\u2713"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"company"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"\u2713"})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"memory-entry-schema",children:"Memory Entry Schema"}),"\n",(0,t.jsx)(n.h3,{id:"core-schema",children:"Core Schema"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"/**\n * A single memory entry in the system.\n */\ninterface MemoryEntry {\n  /** Unique identifier (provider-generated or UUID) */\n  id: string;\n  \n  /** The memory content (human-readable text) */\n  content: string;\n  \n  /** Layer this memory belongs to */\n  layer: MemoryLayer;\n  \n  /** Layer-specific identifiers */\n  identifiers: LayerIdentifiers;\n  \n  /** Arbitrary metadata */\n  metadata: MemoryMetadata;\n  \n  /** Creation timestamp (ISO 8601) */\n  createdAt: string;\n  \n  /** Last update timestamp (ISO 8601) */\n  updatedAt: string;\n  \n  /** Vector embedding (provider-specific format) */\n  embedding?: number[];\n}\n\ntype MemoryLayer = \n  | 'agent'\n  | 'user'\n  | 'session'\n  | 'project'\n  | 'team'\n  | 'org'\n  | 'company';\n"})}),"\n",(0,t.jsx)(n.h3,{id:"metadata-schema",children:"Metadata Schema"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"/**\n * Flexible metadata attached to memories.\n */\ninterface MemoryMetadata {\n  /** Optional: Tags for categorization */\n  tags?: string[];\n  \n  /** Optional: Source of this memory */\n  source?: MemorySource;\n  \n  /** Optional: Pointer to knowledge item (see 04-memory-knowledge-sync.md) */\n  knowledgePointer?: KnowledgePointer;\n  \n  /** Optional: Relevance score (0.0 - 1.0) */\n  relevance?: number;\n  \n  /** Optional: Decay factor for aging */\n  decayFactor?: number;\n  \n  /** Custom fields (string keys, JSON-serializable values) */\n  [key: string]: unknown;\n}\n\ninterface MemorySource {\n  /** Source type */\n  type: 'conversation' | 'tool_result' | 'knowledge_sync' | 'manual' | 'import';\n  \n  /** Optional: Reference to source (message ID, tool call ID, etc.) */\n  reference?: string;\n}\n\ninterface KnowledgePointer {\n  /** Type of knowledge item */\n  sourceType: 'adr' | 'policy' | 'pattern' | 'spec';\n  \n  /** ID of knowledge item */\n  sourceId: string;\n  \n  /** Content hash at sync time */\n  contentHash: string;\n  \n  /** Sync timestamp */\n  syncedAt: string;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"example-memory-entries",children:"Example Memory Entries"}),"\n",(0,t.jsx)(n.h4,{id:"agent-level-memory",children:"Agent-Level Memory"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "id": "mem_agent_001",\n  "content": "When debugging TypeScript, always check tsconfig.json first",\n  "layer": "agent",\n  "identifiers": {\n    "agentId": "agent_debugger",\n    "userId": "user_123"\n  },\n  "metadata": {\n    "tags": ["debugging", "typescript"],\n    "source": {\n      "type": "conversation",\n      "reference": "msg_abc123"\n    }\n  },\n  "createdAt": "2025-01-07T10:30:00Z",\n  "updatedAt": "2025-01-07T10:30:00Z"\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"project-level-memory-knowledge-pointer",children:"Project-Level Memory (Knowledge Pointer)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "id": "mem_proj_042",\n  "content": "Use PostgreSQL for all new services per ADR-042",\n  "layer": "project",\n  "identifiers": {\n    "projectId": "proj_backend_api"\n  },\n  "metadata": {\n    "tags": ["database", "architecture"],\n    "source": {\n      "type": "knowledge_sync"\n    },\n    "knowledgePointer": {\n      "sourceType": "adr",\n      "sourceId": "adr-042-database-selection",\n      "contentHash": "sha256:abc123def456...",\n      "syncedAt": "2025-01-07T09:00:00Z"\n    }\n  },\n  "createdAt": "2025-01-07T09:00:00Z",\n  "updatedAt": "2025-01-07T09:00:00Z"\n}\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"core-operations",children:"Core Operations"}),"\n",(0,t.jsx)(n.h3,{id:"operation-add-memory",children:"Operation: Add Memory"}),"\n",(0,t.jsx)(n.p,{children:"Add a new memory entry to a specific layer."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface AddMemoryInput {\n  /** Memory content (required) */\n  content: string;\n  \n  /** Target layer (required) */\n  layer: MemoryLayer;\n  \n  /** Layer identifiers (required fields depend on layer) */\n  identifiers: LayerIdentifiers;\n  \n  /** Optional metadata */\n  metadata?: Partial<MemoryMetadata>;\n}\n\ninterface AddMemoryOutput {\n  /** Created memory entry */\n  memory: MemoryEntry;\n  \n  /** Whether embedding was generated */\n  embeddingGenerated: boolean;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Validate ",(0,t.jsx)(n.code,{children:"identifiers"})," contains required fields for ",(0,t.jsx)(n.code,{children:"layer"})]}),"\n",(0,t.jsxs)(n.li,{children:["Generate embedding from ",(0,t.jsx)(n.code,{children:"content"})," via provider"]}),"\n",(0,t.jsx)(n.li,{children:"Persist to provider with layer isolation"}),"\n",(0,t.jsxs)(n.li,{children:["Return created entry with generated ",(0,t.jsx)(n.code,{children:"id"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Errors:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Error"}),(0,t.jsx)(n.th,{children:"Condition"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"INVALID_LAYER"})}),(0,t.jsx)(n.td,{children:"Unknown layer value"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"MISSING_IDENTIFIER"})}),(0,t.jsx)(n.td,{children:"Required identifier not provided"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONTENT_TOO_LONG"})}),(0,t.jsx)(n.td,{children:"Content exceeds provider limit"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"EMBEDDING_FAILED"})}),(0,t.jsx)(n.td,{children:"Embedding generation failed"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"PROVIDER_ERROR"})}),(0,t.jsx)(n.td,{children:"Provider-specific error"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"operation-search-memory",children:"Operation: Search Memory"}),"\n",(0,t.jsx)(n.p,{children:"Search for memories semantically matching a query."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface SearchMemoryInput {\n  /** Search query (natural language) */\n  query: string;\n  \n  /** Layers to search (default: all accessible layers) */\n  layers?: MemoryLayer[];\n  \n  /** Layer identifiers for scoping */\n  identifiers: LayerIdentifiers;\n  \n  /** Maximum results per layer (default: 10) */\n  limit?: number;\n  \n  /** Minimum similarity threshold (0.0 - 1.0, default: 0.7) */\n  threshold?: number;\n  \n  /** Optional: Filter by metadata */\n  filter?: MetadataFilter;\n}\n\ninterface MetadataFilter {\n  /** Match any of these tags */\n  tags?: string[];\n  \n  /** Match source type */\n  sourceType?: MemorySource['type'];\n  \n  /** Only knowledge pointers */\n  hasKnowledgePointer?: boolean;\n  \n  /** Custom field filters */\n  custom?: Record<string, unknown>;\n}\n\ninterface SearchMemoryOutput {\n  /** Search results, ordered by relevance */\n  results: MemorySearchResult[];\n  \n  /** Total results before limit */\n  totalCount: number;\n  \n  /** Layers that were searched */\n  searchedLayers: MemoryLayer[];\n}\n\ninterface MemorySearchResult {\n  /** The memory entry */\n  memory: MemoryEntry;\n  \n  /** Similarity score (0.0 - 1.0) */\n  score: number;\n  \n  /** Layer this result came from */\n  layer: MemoryLayer;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Generate embedding for ",(0,t.jsx)(n.code,{children:"query"})]}),"\n",(0,t.jsxs)(n.li,{children:["For each layer in ",(0,t.jsx)(n.code,{children:"layers"}),":\na. Verify ",(0,t.jsx)(n.code,{children:"identifiers"})," provides required fields\nb. Execute vector similarity search\nc. Apply ",(0,t.jsx)(n.code,{children:"threshold"})," filter\nd. Apply ",(0,t.jsx)(n.code,{children:"filter"})," if provided"]}),"\n",(0,t.jsxs)(n.li,{children:["Merge results using layer precedence (see ",(0,t.jsx)(n.a,{href:"#layer-resolution",children:"Layer Resolution"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Return top ",(0,t.jsx)(n.code,{children:"limit"})," results"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Errors:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Error"}),(0,t.jsx)(n.th,{children:"Condition"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"INVALID_LAYER"})}),(0,t.jsxs)(n.td,{children:["Unknown layer in ",(0,t.jsx)(n.code,{children:"layers"})," array"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"MISSING_IDENTIFIER"})}),(0,t.jsx)(n.td,{children:"Required identifier for layer not provided"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"QUERY_TOO_LONG"})}),(0,t.jsx)(n.td,{children:"Query exceeds embedding limit"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"PROVIDER_ERROR"})}),(0,t.jsx)(n.td,{children:"Provider-specific error"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"operation-get-memory",children:"Operation: Get Memory"}),"\n",(0,t.jsx)(n.p,{children:"Retrieve a specific memory by ID."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface GetMemoryInput {\n  /** Memory ID */\n  id: string;\n}\n\ninterface GetMemoryOutput {\n  /** The memory entry, or null if not found */\n  memory: MemoryEntry | null;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Look up memory by ",(0,t.jsx)(n.code,{children:"id"})," in provider"]}),"\n",(0,t.jsx)(n.li,{children:"Return entry or null"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"operation-update-memory",children:"Operation: Update Memory"}),"\n",(0,t.jsx)(n.p,{children:"Update an existing memory's content or metadata."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface UpdateMemoryInput {\n  /** Memory ID */\n  id: string;\n  \n  /** New content (optional, triggers re-embedding) */\n  content?: string;\n  \n  /** Metadata updates (merged with existing) */\n  metadata?: Partial<MemoryMetadata>;\n}\n\ninterface UpdateMemoryOutput {\n  /** Updated memory entry */\n  memory: MemoryEntry;\n  \n  /** Whether embedding was regenerated */\n  embeddingRegenerated: boolean;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Fetch existing memory by ",(0,t.jsx)(n.code,{children:"id"})]}),"\n",(0,t.jsxs)(n.li,{children:["If ",(0,t.jsx)(n.code,{children:"content"})," changed, regenerate embedding"]}),"\n",(0,t.jsxs)(n.li,{children:["Merge ",(0,t.jsx)(n.code,{children:"metadata"})," with existing (shallow merge)"]}),"\n",(0,t.jsxs)(n.li,{children:["Update ",(0,t.jsx)(n.code,{children:"updatedAt"})," timestamp"]}),"\n",(0,t.jsx)(n.li,{children:"Persist to provider"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Errors:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Error"}),(0,t.jsx)(n.th,{children:"Condition"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"MEMORY_NOT_FOUND"})}),(0,t.jsx)(n.td,{children:"No memory with given ID"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONTENT_TOO_LONG"})}),(0,t.jsx)(n.td,{children:"New content exceeds limit"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"EMBEDDING_FAILED"})}),(0,t.jsx)(n.td,{children:"Re-embedding failed"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"operation-delete-memory",children:"Operation: Delete Memory"}),"\n",(0,t.jsx)(n.p,{children:"Remove a memory from the system."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface DeleteMemoryInput {\n  /** Memory ID */\n  id: string;\n}\n\ninterface DeleteMemoryOutput {\n  /** Whether deletion succeeded */\n  success: boolean;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Behavior:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Remove memory from provider"}),"\n",(0,t.jsx)(n.li,{children:"Return success status"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"operation-list-memories",children:"Operation: List Memories"}),"\n",(0,t.jsx)(n.p,{children:"List memories in a specific layer with pagination."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ListMemoriesInput {\n  /** Target layer */\n  layer: MemoryLayer;\n  \n  /** Layer identifiers */\n  identifiers: LayerIdentifiers;\n  \n  /** Pagination cursor */\n  cursor?: string;\n  \n  /** Page size (default: 50, max: 100) */\n  limit?: number;\n  \n  /** Optional: Filter by metadata */\n  filter?: MetadataFilter;\n}\n\ninterface ListMemoriesOutput {\n  /** Memories in this page */\n  memories: MemoryEntry[];\n  \n  /** Cursor for next page (null if no more) */\n  nextCursor: string | null;\n  \n  /** Total count in layer */\n  totalCount: number;\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"layer-resolution",children:"Layer Resolution"}),"\n",(0,t.jsx)(n.h3,{id:"precedence-rules",children:"Precedence Rules"}),"\n",(0,t.jsx)(n.p,{children:"When searching across multiple layers, results are merged using these rules:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   LAYER PRECEDENCE                               \u2502\n\u2502                                                                  \u2502\n\u2502  1. agent    (highest priority - most specific)                 \u2502\n\u2502  2. user                                                        \u2502\n\u2502  3. session                                                     \u2502\n\u2502  4. project                                                     \u2502\n\u2502  5. team                                                        \u2502\n\u2502  6. org                                                         \u2502\n\u2502  7. company  (lowest priority - least specific)                 \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.h3,{id:"merge-algorithm",children:"Merge Algorithm"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function mergeSearchResults(\n  resultsByLayer: Map<MemoryLayer, MemorySearchResult[]>,\n  limit: number\n): MemorySearchResult[] {\n  // 1. Flatten all results\n  const allResults: MemorySearchResult[] = [];\n  for (const [layer, results] of resultsByLayer) {\n    allResults.push(...results);\n  }\n  \n  // 2. Sort by: layer precedence (primary), score (secondary)\n  allResults.sort((a, b) => {\n    const layerDiff = getLayerPrecedence(a.layer) - getLayerPrecedence(b.layer);\n    if (layerDiff !== 0) return layerDiff;\n    return b.score - a.score; // Higher score first\n  });\n  \n  // 3. Deduplicate by content similarity (optional)\n  const deduped = deduplicateBySimilarity(allResults, 0.95);\n  \n  // 4. Return top N\n  return deduped.slice(0, limit);\n}\n\nfunction getLayerPrecedence(layer: MemoryLayer): number {\n  const precedence: Record<MemoryLayer, number> = {\n    agent: 1,\n    user: 2,\n    session: 3,\n    project: 4,\n    team: 5,\n    org: 6,\n    company: 7\n  };\n  return precedence[layer];\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"override-behavior",children:"Override Behavior"}),"\n",(0,t.jsxs)(n.p,{children:["More specific layers ",(0,t.jsx)(n.strong,{children:"override"})," less specific layers when content conflicts:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                                  \u2502\n\u2502  company layer: "Use spaces for indentation"                    \u2502\n\u2502                              \u2502                                   \u2502\n\u2502                              \u25bc                                   \u2502\n\u2502  project layer: "Use tabs for indentation"  \u25c4\u2500\u2500 WINS            \u2502\n\u2502                                                                  \u2502\n\u2502  Result: Agent uses tabs (project overrides company)            \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,t.jsx)(n.h3,{id:"layer-access-control",children:"Layer Access Control"}),"\n",(0,t.jsx)(n.p,{children:"Layers are only searchable if appropriate identifiers are provided:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function getAccessibleLayers(identifiers: LayerIdentifiers): MemoryLayer[] {\n  const layers: MemoryLayer[] = [];\n  \n  // Always accessible with company ID\n  if (identifiers.companyId) layers.push('company');\n  \n  // Org requires org ID\n  if (identifiers.orgId) layers.push('org');\n  \n  // Team requires team ID\n  if (identifiers.teamId) layers.push('team');\n  \n  // Project requires project ID\n  if (identifiers.projectId) layers.push('project');\n  \n  // Session requires user + session ID\n  if (identifiers.userId && identifiers.sessionId) layers.push('session');\n  \n  // User requires user ID\n  if (identifiers.userId) layers.push('user');\n  \n  // Agent requires agent + user ID\n  if (identifiers.agentId && identifiers.userId) layers.push('agent');\n  \n  return layers;\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"provider-adapter-interface",children:"Provider Adapter Interface"}),"\n",(0,t.jsx)(n.h3,{id:"interface-definition",children:"Interface Definition"}),"\n",(0,t.jsx)(n.p,{children:"All memory providers must implement this interface:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"/**\n * Memory provider adapter interface.\n * Implement this to add support for a new storage backend.\n */\ninterface MemoryProviderAdapter {\n  /** Provider name (e.g., \"mem0\", \"letta\", \"chroma\") */\n  readonly name: string;\n  \n  /** Provider version */\n  readonly version: string;\n  \n  /** Initialize the provider connection */\n  initialize(config: ProviderConfig): Promise<void>;\n  \n  /** Clean up resources */\n  shutdown(): Promise<void>;\n  \n  /** Health check */\n  healthCheck(): Promise<HealthCheckResult>;\n  \n  // Core operations\n  add(input: AddMemoryInput): Promise<AddMemoryOutput>;\n  search(input: SearchMemoryInput): Promise<SearchMemoryOutput>;\n  get(input: GetMemoryInput): Promise<GetMemoryOutput>;\n  update(input: UpdateMemoryInput): Promise<UpdateMemoryOutput>;\n  delete(input: DeleteMemoryInput): Promise<DeleteMemoryOutput>;\n  list(input: ListMemoriesInput): Promise<ListMemoriesOutput>;\n  \n  // Embedding operations\n  generateEmbedding(content: string): Promise<number[]>;\n  \n  // Bulk operations (optional)\n  bulkAdd?(inputs: AddMemoryInput[]): Promise<AddMemoryOutput[]>;\n  bulkDelete?(ids: string[]): Promise<{ deleted: number; failed: string[] }>;\n}\n\ninterface ProviderConfig {\n  /** Provider-specific configuration */\n  [key: string]: unknown;\n}\n\ninterface HealthCheckResult {\n  /** Overall health status */\n  status: 'healthy' | 'degraded' | 'unhealthy';\n  \n  /** Latency in milliseconds */\n  latencyMs: number;\n  \n  /** Optional: Detailed component health */\n  components?: Record<string, {\n    status: 'healthy' | 'degraded' | 'unhealthy';\n    message?: string;\n  }>;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"layer-isolation",children:"Layer Isolation"}),"\n",(0,t.jsx)(n.p,{children:"Providers MUST ensure layer isolation. Implementation strategies:"}),"\n",(0,t.jsx)(n.h4,{id:"strategy-1-namespace-by-layer",children:"Strategy 1: Namespace by Layer"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Collection: memories_agent_{agentId}_{userId}\nCollection: memories_user_{userId}\nCollection: memories_session_{userId}_{sessionId}\nCollection: memories_project_{projectId}\n...\n"})}),"\n",(0,t.jsx)(n.h4,{id:"strategy-2-metadata-filtering",children:"Strategy 2: Metadata Filtering"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "content": "...",\n  "metadata": {\n    "_layer": "project",\n    "_projectId": "proj_123"\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Query with filter: ",(0,t.jsx)(n.code,{children:'metadata._layer == "project" AND metadata._projectId == "proj_123"'})]}),"\n",(0,t.jsx)(n.h4,{id:"strategy-3-tenant-partitioning",children:"Strategy 3: Tenant Partitioning"}),"\n",(0,t.jsx)(n.p,{children:"Use provider's native multi-tenancy:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Qdrant: Separate collections per layer"}),"\n",(0,t.jsx)(n.li,{children:"Pinecone: Namespaces per layer"}),"\n",(0,t.jsx)(n.li,{children:"Chroma: Collections per layer"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"memory-lifecycle",children:"Memory Lifecycle"}),"\n",(0,t.jsx)(n.h3,{id:"state-diagram",children:"State Diagram"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                                                                  \u2502\n\u2502                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                              \u2502\n\u2502                        \u2502 CREATED \u2502                              \u2502\n\u2502                        \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518                              \u2502\n\u2502                             \u2502                                    \u2502\n\u2502                             \u25bc                                    \u2502\n\u2502                        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                              \u2502\n\u2502              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\u2502 ACTIVE  \u2502\u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                    \u2502\n\u2502              \u2502         \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518         \u2502                    \u2502\n\u2502              \u2502              \u2502              \u2502                    \u2502\n\u2502              \u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502                    \u2502\n\u2502              \u2502    \u2502                   \u2502    \u2502                    \u2502\n\u2502              \u2502    \u25bc                   \u25bc    \u2502                    \u2502\n\u2502         \u250c\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2510             \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                     \u2502\n\u2502         \u2502 UPDATED \u2502             \u2502 DECAYED \u2502                     \u2502\n\u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518             \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518                     \u2502\n\u2502                                      \u2502                          \u2502\n\u2502                                      \u25bc                          \u2502\n\u2502                                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                     \u2502\n\u2502                                \u2502 ARCHIVED \u2502                     \u2502\n\u2502                                \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518                     \u2502\n\u2502                                     \u2502                           \u2502\n\u2502                                     \u25bc                           \u2502\n\u2502                                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                      \u2502\n\u2502                                \u2502 DELETED \u2502                      \u2502\n\u2502                                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                      \u2502\n\u2502                                                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.h3,{id:"memory-decay-optional",children:"Memory Decay (Optional)"}),"\n",(0,t.jsx)(n.p,{children:"Providers MAY support memory decay to reduce old memory relevance:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface DecayConfig {\n  /** Enable decay */\n  enabled: boolean;\n  \n  /** Decay rate per day (0.0 - 1.0) */\n  ratePerDay: number;\n  \n  /** Minimum relevance before archival */\n  archiveThreshold: number;\n  \n  /** Layers exempt from decay */\n  exemptLayers: MemoryLayer[];\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Decay Formula:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"relevance(t) = initial_relevance * (1 - rate)^days_since_creation\n"})}),"\n",(0,t.jsx)(n.h3,{id:"memory-consolidation-optional",children:"Memory Consolidation (Optional)"}),"\n",(0,t.jsx)(n.p,{children:"Providers MAY support consolidation to merge similar memories:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ConsolidationConfig {\n  /** Enable consolidation */\n  enabled: boolean;\n  \n  /** Similarity threshold for merging (0.0 - 1.0) */\n  similarityThreshold: number;\n  \n  /** Maximum memories before triggering consolidation */\n  maxMemoriesBeforeTrigger: number;\n  \n  /** Layers to consolidate */\n  targetLayers: MemoryLayer[];\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"session-memory-cleanup",children:"Session Memory Cleanup"}),"\n",(0,t.jsx)(n.p,{children:"Session-layer memories have special lifecycle:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:'interface SessionCleanupConfig {\n  /** Auto-delete session memories after session ends */\n  autoDelete: boolean;\n  \n  /** Retention period after session end (e.g., "7d", "30d") */\n  retentionPeriod?: string;\n  \n  /** Promote important memories to user layer */\n  promoteImportant: boolean;\n  \n  /** Threshold for promotion (0.0 - 1.0) */\n  promotionThreshold?: number;\n}\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,t.jsx)(n.h3,{id:"error-response-format",children:"Error Response Format"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface MemoryError {\n  /** Error code */\n  code: MemoryErrorCode;\n  \n  /** Human-readable message */\n  message: string;\n  \n  /** Operation that failed */\n  operation: string;\n  \n  /** Additional context */\n  details?: Record<string, unknown>;\n  \n  /** Whether operation can be retried */\n  retryable: boolean;\n}\n\ntype MemoryErrorCode =\n  | 'INVALID_LAYER'\n  | 'MISSING_IDENTIFIER'\n  | 'MEMORY_NOT_FOUND'\n  | 'CONTENT_TOO_LONG'\n  | 'QUERY_TOO_LONG'\n  | 'EMBEDDING_FAILED'\n  | 'PROVIDER_ERROR'\n  | 'RATE_LIMITED'\n  | 'UNAUTHORIZED'\n  | 'CONFIGURATION_ERROR';\n"})}),"\n",(0,t.jsx)(n.h3,{id:"error-handling-guidelines",children:"Error Handling Guidelines"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Error Code"}),(0,t.jsx)(n.th,{children:"Recommended Action"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"INVALID_LAYER"})}),(0,t.jsx)(n.td,{children:"Fix input, do not retry"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"MISSING_IDENTIFIER"})}),(0,t.jsx)(n.td,{children:"Add required identifier, do not retry"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"MEMORY_NOT_FOUND"})}),(0,t.jsx)(n.td,{children:"Check ID, may be deleted"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONTENT_TOO_LONG"})}),(0,t.jsx)(n.td,{children:"Truncate or split content"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"QUERY_TOO_LONG"})}),(0,t.jsx)(n.td,{children:"Shorten query"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"EMBEDDING_FAILED"})}),(0,t.jsx)(n.td,{children:"Retry with backoff"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"PROVIDER_ERROR"})}),(0,t.jsx)(n.td,{children:"Retry with backoff, check provider status"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"RATE_LIMITED"})}),(0,t.jsxs)(n.td,{children:["Retry after delay (use ",(0,t.jsx)(n.code,{children:"Retry-After"})," if provided)"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"UNAUTHORIZED"})}),(0,t.jsx)(n.td,{children:"Check credentials, do not retry"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"CONFIGURATION_ERROR"})}),(0,t.jsx)(n.td,{children:"Fix configuration, do not retry"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"retry-strategy",children:"Retry Strategy"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface RetryConfig {\n  /** Maximum retry attempts */\n  maxAttempts: number;\n  \n  /** Initial delay in milliseconds */\n  initialDelayMs: number;\n  \n  /** Maximum delay in milliseconds */\n  maxDelayMs: number;\n  \n  /** Backoff multiplier */\n  backoffMultiplier: number;\n  \n  /** Error codes to retry */\n  retryableCodes: MemoryErrorCode[];\n}\n\nconst defaultRetryConfig: RetryConfig = {\n  maxAttempts: 3,\n  initialDelayMs: 1000,\n  maxDelayMs: 30000,\n  backoffMultiplier: 2,\n  retryableCodes: ['EMBEDDING_FAILED', 'PROVIDER_ERROR', 'RATE_LIMITED']\n};\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"implementation-notes",children:"Implementation Notes"}),"\n",(0,t.jsx)(n.h3,{id:"thread-safety",children:"Thread Safety"}),"\n",(0,t.jsx)(n.p,{children:"Memory operations MUST be thread-safe. Implementations should:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Use atomic operations where possible"}),"\n",(0,t.jsx)(n.li,{children:"Implement optimistic locking for updates"}),"\n",(0,t.jsx)(n.li,{children:"Handle concurrent access to same memory gracefully"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"caching",children:"Caching"}),"\n",(0,t.jsx)(n.p,{children:"Implementations MAY cache:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Embeddings for frequently accessed content"}),"\n",(0,t.jsx)(n.li,{children:"Layer resolution results"}),"\n",(0,t.jsx)(n.li,{children:"Provider connection metadata"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Implementations MUST NOT cache:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Memory content (may be stale)"}),"\n",(0,t.jsx)(n.li,{children:"Search results (query-dependent)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"observability",children:"Observability"}),"\n",(0,t.jsx)(n.p,{children:"Implementations SHOULD emit metrics:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Metric"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"memory.operations.total"})}),(0,t.jsx)(n.td,{children:"Counter"}),(0,t.jsx)(n.td,{children:"Total operations by type"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"memory.operations.errors"})}),(0,t.jsx)(n.td,{children:"Counter"}),(0,t.jsx)(n.td,{children:"Failed operations by error code"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"memory.operations.latency"})}),(0,t.jsx)(n.td,{children:"Histogram"}),(0,t.jsx)(n.td,{children:"Operation latency in ms"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"memory.search.results"})}),(0,t.jsx)(n.td,{children:"Histogram"}),(0,t.jsx)(n.td,{children:"Number of results per search"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"memory.storage.size"})}),(0,t.jsx)(n.td,{children:"Gauge"}),(0,t.jsx)(n.td,{children:"Total memories by layer"})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Next"}),": ",(0,t.jsx)(n.a,{href:"/aeterna/docs/specs/knowledge-repository",children:"03-knowledge-repository.md"})," - Knowledge Repository Specification"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453(e,n,r){r.d(n,{R:()=>d,x:()=>l});var i=r(6540);const t={},s=i.createContext(t);function d(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);