"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[9895],{966(e,n,r){r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"helm/cnpg-upgrade","title":"CloudNativePG Upgrade Procedure","description":"This guide covers upgrading CloudNativePG (CNPG), the PostgreSQL operator managing database clusters in Aeterna deployments. CNPG handles both operator upgrades and PostgreSQL instance version management.","source":"@site/docs/helm/cnpg-upgrade.md","sourceDirName":"helm","slug":"/helm/cnpg-upgrade","permalink":"/aeterna/docs/helm/cnpg-upgrade","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/helm/cnpg-upgrade.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Upgrade Guide","permalink":"/aeterna/docs/helm/upgrade"},"next":{"title":"Backup Restore Procedure","permalink":"/aeterna/docs/helm/restore"}}');var t=r(4848),s=r(8453);const i={},l="CloudNativePG Upgrade Procedure",o={},c=[{value:"Version Compatibility",id:"version-compatibility",level:2},{value:"Pre-Upgrade Checklist",id:"pre-upgrade-checklist",level:2},{value:"1. Backup Production Databases",id:"1-backup-production-databases",level:3},{value:"2. Test Upgrade in Staging",id:"2-test-upgrade-in-staging",level:3},{value:"3. Check Cluster Health",id:"3-check-cluster-health",level:3},{value:"Operator Upgrade Steps",id:"operator-upgrade-steps",level:2},{value:"Step 1: Update Helm Values",id:"step-1-update-helm-values",level:3},{value:"Step 2: Dry-Run Upgrade",id:"step-2-dry-run-upgrade",level:3},{value:"Step 3: Execute Upgrade",id:"step-3-execute-upgrade",level:3},{value:"Step 4: Verify Operator is Ready",id:"step-4-verify-operator-is-ready",level:3},{value:"Post-Upgrade Validation",id:"post-upgrade-validation",level:2},{value:"1. Database Accessibility",id:"1-database-accessibility",level:3},{value:"2. Extension Verification",id:"2-extension-verification",level:3},{value:"3. Replication Status",id:"3-replication-status",level:3},{value:"Rollback Procedure",id:"rollback-procedure",level:2},{value:"Quick Rollback (within 30 minutes)",id:"quick-rollback-within-30-minutes",level:3},{value:"Full Rollback (after 30 minutes)",id:"full-rollback-after-30-minutes",level:3},{value:"Major PostgreSQL Version Upgrades",id:"major-postgresql-version-upgrades",level:2},{value:"1. Prepare Cluster for Upgrade",id:"1-prepare-cluster-for-upgrade",level:3},{value:"2. Monitor pg_upgrade Process",id:"2-monitor-pg_upgrade-process",level:3},{value:"3. Verify Post-Upgrade",id:"3-verify-post-upgrade",level:3},{value:"Monitoring During Upgrade",id:"monitoring-during-upgrade",level:2},{value:"Key Metrics to Watch",id:"key-metrics-to-watch",level:3},{value:"Prometheus Queries (if monitoring enabled)",id:"prometheus-queries-if-monitoring-enabled",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Operator Stuck in CrashLoopBackOff",id:"operator-stuck-in-crashloopbackoff",level:3},{value:"Cluster Won&#39;t Reconcile After Upgrade",id:"cluster-wont-reconcile-after-upgrade",level:3},{value:"Reference: CloudNativePG Values Section",id:"reference-cloudnativepg-values-section",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"cloudnativepg-upgrade-procedure",children:"CloudNativePG Upgrade Procedure"})}),"\n",(0,t.jsx)(n.p,{children:"This guide covers upgrading CloudNativePG (CNPG), the PostgreSQL operator managing database clusters in Aeterna deployments. CNPG handles both operator upgrades and PostgreSQL instance version management."}),"\n",(0,t.jsx)(n.h2,{id:"version-compatibility",children:"Version Compatibility"}),"\n",(0,t.jsxs)(n.p,{children:["The Aeterna chart pins CloudNativePG to version ",(0,t.jsx)(n.strong,{children:"0.23.x"})," series. Check your current version:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl get deployment -n cnpg-system cnpg-controller-manager -o jsonpath='{.spec.template.spec.containers[0].image}'\n# Output example: ghcr.io/cloudnative-pg/cloudnative-pg:1.23.1\n"})}),"\n",(0,t.jsx)(n.p,{children:"Verify compatibility with your PostgreSQL instances:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"CNPG 0.23.x supports PostgreSQL 12, 13, 14, 15, 16"}),"\n",(0,t.jsx)(n.li,{children:"Extensions (pgvector, PostGIS, etc.) must match PostgreSQL minor version"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"pre-upgrade-checklist",children:"Pre-Upgrade Checklist"}),"\n",(0,t.jsx)(n.h3,{id:"1-backup-production-databases",children:"1. Backup Production Databases"}),"\n",(0,t.jsx)(n.p,{children:"Create a backup before any upgrade:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Trigger immediate backup via CNPG API\nkubectl patch cluster aeterna-db -n aeterna \\\n  -p \'{"spec":{"backup":{"immediateBackup":true}}}\' --type=merge\n\n# Wait for backup to complete\nkubectl get backup -n aeterna --watch\n\n# Verify backup was stored\nkubectl describe cluster aeterna-db -n aeterna | grep -A5 "Last Successful Backup"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"2-test-upgrade-in-staging",children:"2. Test Upgrade in Staging"}),"\n",(0,t.jsx)(n.p,{children:"Never upgrade production directly. Create a staging environment:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Clone PostgreSQL instance from production backup\nkubectl apply -f - <<EOF\napiVersion: postgresql.cnpg.io/v1\nkind: Cluster\nmetadata:\n  name: aeterna-db-staging\n  namespace: aeterna\nspec:\n  instances: 3\n  postgresql:\n    parameters:\n      shared_preload_libraries: "pgvector"\n  bootstrap:\n    recovery:\n      source: aeterna-db-prod-backup\n      recoveryTarget:\n        timeline: latest\nEOF\n\n# Wait for recovery to complete\nkubectl logs -n aeterna aeterna-db-staging-1 -f | grep "consistent recovery point reached"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"3-check-cluster-health",children:"3. Check Cluster Health"}),"\n",(0,t.jsx)(n.p,{children:"Verify all replicas are healthy:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'kubectl get pod -n aeterna -l cnpg.io/cluster=aeterna-db\n# All pods should show STATUS: Running\n\n# Verify streaming replication is active\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -c "\\x" -c "SELECT * FROM pg_stat_replication;"\n# Should show all replicas in "streaming" state\n\n# Check extension versions\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -c "SELECT name, version FROM pg_available_extensions WHERE name IN (\'pgvector\', \'uuid-ossp\');"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"operator-upgrade-steps",children:"Operator Upgrade Steps"}),"\n",(0,t.jsx)(n.h3,{id:"step-1-update-helm-values",children:"Step 1: Update Helm Values"}),"\n",(0,t.jsxs)(n.p,{children:["Edit ",(0,t.jsx)(n.code,{children:"values-prod.yaml"})," to pin the new CNPG version:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'postgresql:\n  cloudnativepg:\n    enabled: true\n    # Helm chart version for CNPG operator\n    version: "0.23.x"  # e.g., 0.23.3\n    # Repository URL (CNPG hosts its own chart)\n    repository: "https://cloudnative-pg.github.io/charts"\n    # Image tag for operator\n    operatorImage:\n      tag: "1.23.1"  # Matches version above\n'})}),"\n",(0,t.jsx)(n.h3,{id:"step-2-dry-run-upgrade",children:"Step 2: Dry-Run Upgrade"}),"\n",(0,t.jsx)(n.p,{children:"Always test before applying:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'helm upgrade aeterna-db ./charts/aeterna \\\n  -n aeterna \\\n  -f values-prod.yaml \\\n  --dry-run \\\n  --debug > upgrade-plan.yaml\n\n# Review the manifest\ncat upgrade-plan.yaml | grep -A10 "kind: Deployment" | head -20\n'})}),"\n",(0,t.jsx)(n.h3,{id:"step-3-execute-upgrade",children:"Step 3: Execute Upgrade"}),"\n",(0,t.jsx)(n.p,{children:"Perform the actual upgrade with a 30-second timeout (CNPG restarts quickly):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"helm upgrade aeterna-db ./charts/aeterna \\\n  -n aeterna \\\n  -f values-prod.yaml \\\n  --timeout 5m \\\n  --wait\n\n# Monitor operator restart\nkubectl rollout status deployment/cnpg-controller-manager -n cnpg-system --timeout=3m\n"})}),"\n",(0,t.jsx)(n.h3,{id:"step-4-verify-operator-is-ready",children:"Step 4: Verify Operator is Ready"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check operator pod is running\nkubectl get pod -n cnpg-system -l app.kubernetes.io/name=cloudnative-pg\n# STATUS should be Running and READY should be 1/1\n\n# Verify operator logs show no errors\nkubectl logs -n cnpg-system -l app.kubernetes.io/name=cloudnative-pg --tail=50 | grep -i error\n# Should return no results\n"})}),"\n",(0,t.jsx)(n.h2,{id:"post-upgrade-validation",children:"Post-Upgrade Validation"}),"\n",(0,t.jsx)(n.h3,{id:"1-database-accessibility",children:"1. Database Accessibility"}),"\n",(0,t.jsx)(n.p,{children:"Test connections to ensure databases are still accessible:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Port-forward to primary pod\nkubectl port-forward -n aeterna aeterna-db-1 5432:5432 &\n\n# Connect using psql\npsql -h localhost -U postgres -d postgres -c "SELECT version();"\n# Output should show PostgreSQL version unchanged (operator doesn\'t auto-upgrade PG)\n\npsql -h localhost -U postgres -d postgres -c "SELECT name, installed_version FROM pg_available_extensions WHERE installed_version IS NOT NULL;"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"2-extension-verification",children:"2. Extension Verification"}),"\n",(0,t.jsx)(n.p,{children:"Critical for pgvector and other extensions:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check pgvector extension is available\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -d aeterna -c "CREATE EXTENSION IF NOT EXISTS pgvector;"\n\n# Verify vector operations work\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -d aeterna -c "SELECT (ARRAY[1,2,3]::vector) <-> (ARRAY[1,1,1]::vector) AS distance;"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"3-replication-status",children:"3. Replication Status"}),"\n",(0,t.jsx)(n.p,{children:"Ensure all secondary replicas caught up:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# On primary\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -c "\nSELECT \n  client_addr,\n  state,\n  write_lag,\n  flush_lag,\n  replay_lag\nFROM pg_stat_replication;"\n\n# All replicas should have write_lag, flush_lag, replay_lag < 1s\n'})}),"\n",(0,t.jsx)(n.h2,{id:"rollback-procedure",children:"Rollback Procedure"}),"\n",(0,t.jsx)(n.p,{children:"If issues occur immediately after upgrade:"}),"\n",(0,t.jsx)(n.h3,{id:"quick-rollback-within-30-minutes",children:"Quick Rollback (within 30 minutes)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Revert Helm chart to previous version\nhelm rollback aeterna-db -n aeterna 1\n\n# Monitor operator restart\nkubectl rollout status deployment/cnpg-controller-manager -n cnpg-system\n\n# Verify cluster reconciliation\nkubectl describe cluster aeterna-db -n aeterna | tail -20\n"})}),"\n",(0,t.jsx)(n.h3,{id:"full-rollback-after-30-minutes",children:"Full Rollback (after 30 minutes)"}),"\n",(0,t.jsx)(n.p,{children:"If quick rollback fails, restore from backup:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Delete failed cluster\nkubectl delete cluster aeterna-db -n aeterna\n\n# Restore from backup taken before upgrade\nkubectl apply -f - <<EOF\napiVersion: postgresql.cnpg.io/v1\nkind: Cluster\nmetadata:\n  name: aeterna-db\n  namespace: aeterna\nspec:\n  instances: 3\n  bootstrap:\n    recovery:\n      source: aeterna-db-backup  # Your pre-upgrade backup\n      recoveryTarget:\n        timeline: latest\nEOF\n\n# Monitor recovery\nkubectl logs -n aeterna aeterna-db-1 -f\n"})}),"\n",(0,t.jsx)(n.h2,{id:"major-postgresql-version-upgrades",children:"Major PostgreSQL Version Upgrades"}),"\n",(0,t.jsxs)(n.p,{children:["When upgrading PostgreSQL itself (e.g., 14 \u2192 15), CNPG uses ",(0,t.jsx)(n.code,{children:"pg_upgrade"}),":"]}),"\n",(0,t.jsx)(n.h3,{id:"1-prepare-cluster-for-upgrade",children:"1. Prepare Cluster for Upgrade"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: postgresql.cnpg.io/v1\nkind: Cluster\nmetadata:\n  name: aeterna-db\n  namespace: aeterna\nspec:\n  postgresql:\n    version: 15  # Change from 14 to 15\n  # CNPG will trigger pg_upgrade automatically\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-monitor-pg_upgrade-process",children:"2. Monitor pg_upgrade Process"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Watch cluster status during upgrade\nkubectl describe cluster aeterna-db -n aeterna --watch\n\n# Monitor pg_upgrade logs (takes 5-30 minutes depending on data size)\nkubectl logs -n aeterna aeterna-db-1 -f | grep -E "pg_upgrade|copy|link|Performing"\n\n# Check progress via psql\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -c "SELECT version();"\n# Should show new PostgreSQL version once upgrade completes\n'})}),"\n",(0,t.jsx)(n.h3,{id:"3-verify-post-upgrade",children:"3. Verify Post-Upgrade"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check all replicas upgraded\nkubectl exec -it aeterna-db-2 -n aeterna -- psql -U postgres -c "SELECT version();"\n\n# Analyze tables after major version upgrade (required)\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -d aeterna -c "ANALYZE;"\n\n# Check extension compatibility with new version\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -c "SELECT * FROM pg_extension WHERE extname = \'pgvector\';"\n'})}),"\n",(0,t.jsx)(n.h2,{id:"monitoring-during-upgrade",children:"Monitoring During Upgrade"}),"\n",(0,t.jsx)(n.h3,{id:"key-metrics-to-watch",children:"Key Metrics to Watch"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Pod restarts (should be 0)\nkubectl get pod -n aeterna -l cnpg.io/cluster=aeterna-db \\\n  --custom-columns=NAME:.metadata.name,RESTARTS:.status.containerStatuses[0].restartCount\n\n# Connection count (should not spike)\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"\n\n# Replication lag (should stay < 1s)\nkubectl exec -it aeterna-db-1 -n aeterna -- psql -U postgres -c "SELECT EXTRACT(EPOCH FROM now() - pg_last_xact_replay_timestamp()) as replication_lag_seconds;"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"prometheus-queries-if-monitoring-enabled",children:"Prometheus Queries (if monitoring enabled)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-promql",children:"# Operator reconciliation duration\ncnpg_operator_reconciliation_duration_seconds\n\n# Database connection count\npg_stat_activity_count\n\n# Replication lag in seconds\npg_replication_lag_seconds\n"})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"operator-stuck-in-crashloopbackoff",children:"Operator Stuck in CrashLoopBackOff"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Check logs for errors\nkubectl logs -n cnpg-system deployment/cnpg-controller-manager --tail=100\n\n# Common cause: incompatible CNPG/PostgreSQL versions\n# Solution: verify version matrix in pre-upgrade checklist\n\n# Force pod restart\nkubectl rollout restart deployment/cnpg-controller-manager -n cnpg-system\n"})}),"\n",(0,t.jsx)(n.h3,{id:"cluster-wont-reconcile-after-upgrade",children:"Cluster Won't Reconcile After Upgrade"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Check cluster conditions\nkubectl describe cluster aeterna-db -n aeterna | grep -A5 "Conditions:"\n\n# If stuck, check pod events\nkubectl describe pod aeterna-db-1 -n aeterna | grep -A10 "Events:"\n\n# Last resort: delete cluster and restore from backup (pre-upgrade)\nkubectl delete cluster aeterna-db -n aeterna\n# Then restore as shown in rollback section\n'})}),"\n",(0,t.jsx)(n.h2,{id:"reference-cloudnativepg-values-section",children:"Reference: CloudNativePG Values Section"}),"\n",(0,t.jsxs)(n.p,{children:["From ",(0,t.jsx)(n.code,{children:"values.yaml"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'postgresql:\n  cloudnativepg:\n    enabled: true\n    # Helm chart repo and version\n    repository: https://cloudnative-pg.github.io/charts\n    version: "0.23.x"\n    \n    # Operator configuration\n    operator:\n      image:\n        repository: ghcr.io/cloudnative-pg/cloudnative-pg\n        tag: "1.23.1"\n      replicas: 2  # HA for operator itself\n    \n    # Cluster configuration\n    cluster:\n      instances: 3  # Number of PostgreSQL replicas\n      postgresql:\n        version: 16\n        parameters:\n          shared_preload_libraries: "pgvector"\n      storage:\n        size: 100Gi\n        storageClass: fast-ssd\n    \n    # Backup configuration\n    backup:\n      enabled: true\n      schedule: "0 2 * * *"  # 2 AM daily\n      retention: 30  # Keep 30 days\n'})}),"\n",(0,t.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Always backup"})," before any upgrade"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Test in staging"})," to catch issues early"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Monitor closely"})," during operator restart"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Verify extensions"})," work after upgrade (pgvector, PostGIS, etc.)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Plan PostgreSQL major version upgrades"})," separately (pg_upgrade is automatic but slow)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Have rollback procedure ready"})," in case of issues"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["For additional help, consult the ",(0,t.jsx)(n.a,{href:"https://cloudnative-pg.io/documentation/current/upgrade/",children:"official CNPG upgrade guide"}),"."]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,r){r.d(n,{R:()=>i,x:()=>l});var a=r(6540);const t={},s=a.createContext(t);function i(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);