"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[4498],{2720(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"cca/redis-schema","title":"CCA Redis Schema Documentation","description":"This document describes the Redis key patterns and data structures used by CCA (Confucius Code Agent) capabilities in Aeterna.","source":"@site/docs/cca/redis-schema.md","sourceDirName":"cca","slug":"/cca/redis-schema","permalink":"/aeterna/docs/cca/redis-schema","draft":false,"unlisted":false,"editUrl":"https://github.com/kikokikok/aeterna/tree/main/website/docs/cca/redis-schema.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"CCA Extension Development Guide","permalink":"/aeterna/docs/cca/extension-guide"},"next":{"title":"CCA Database Migrations","permalink":"/aeterna/docs/cca/migrations"}}');var t=s(4848),r=s(8453);const d={},c="CCA Redis Schema Documentation",l={},a=[{value:"Overview",id:"overview",level:2},{value:"Key Patterns",id:"key-patterns",level:2},{value:"Summary Cache Keys",id:"summary-cache-keys",level:3},{value:"Extension State Keys",id:"extension-state-keys",level:3},{value:"Distributed Lock Keys",id:"distributed-lock-keys",level:3},{value:"Job Coordination Keys",id:"job-coordination-keys",level:3},{value:"Job Completion Tracking",id:"job-completion-tracking",level:4},{value:"Job Checkpoints",id:"job-checkpoints",level:4},{value:"Event Stream Keys",id:"event-stream-keys",level:3},{value:"Trajectory Events",id:"trajectory-events",level:4},{value:"Governance Events",id:"governance-events",level:4},{value:"Budget Tracking Keys",id:"budget-tracking-keys",level:3},{value:"Summarization Budget",id:"summarization-budget",level:4},{value:"Circuit Breaker Keys",id:"circuit-breaker-keys",level:3},{value:"Data Structures by Component",id:"data-structures-by-component",level:2},{value:"Context Architect",id:"context-architect",level:3},{value:"Note-Taking Agent",id:"note-taking-agent",level:3},{value:"Hindsight Learning",id:"hindsight-learning",level:3},{value:"Meta-Agent",id:"meta-agent",level:3},{value:"Extension System",id:"extension-system",level:3},{value:"Memory Management",id:"memory-management",level:2},{value:"LRU Eviction for Extension State",id:"lru-eviction-for-extension-state",level:3},{value:"Compression",id:"compression",level:3},{value:"Monitoring Keys",id:"monitoring-keys",level:2},{value:"Metrics (for observability integration)",id:"metrics-for-observability-integration",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Environment Variables",id:"environment-variables",level:3},{value:"Config File (aeterna.toml)",id:"config-file-aeternatoml",level:3},{value:"Cleanup Procedures",id:"cleanup-procedures",level:2},{value:"Expired Cache Cleanup",id:"expired-cache-cleanup",level:3},{value:"Orphaned State Cleanup",id:"orphaned-state-cleanup",level:3},{value:"Stream Trimming",id:"stream-trimming",level:3},{value:"High Availability Considerations",id:"high-availability-considerations",level:2},{value:"Redis Cluster",id:"redis-cluster",level:3},{value:"Redis Sentinel",id:"redis-sentinel",level:3},{value:"Replication Lag",id:"replication-lag",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"High Memory Usage",id:"high-memory-usage",level:3},{value:"Lock Contention",id:"lock-contention",level:3},{value:"Stream Lag",id:"stream-lag",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"cca-redis-schema-documentation",children:"CCA Redis Schema Documentation"})}),"\n",(0,t.jsx)(n.p,{children:"This document describes the Redis key patterns and data structures used by CCA (Confucius Code Agent) capabilities in Aeterna."}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"CCA uses Redis for:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Summary caching"}),": Fast access to pre-computed summaries"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Extension state"}),": Per-session state for extensions"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Distributed locking"}),": Coordination between CCA workers"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Event streaming"}),": Trajectory and error event publication"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"key-patterns",children:"Key Patterns"}),"\n",(0,t.jsx)(n.p,{children:"All CCA-related keys follow the pattern:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"{namespace}:{tenant_id}:{component}:{...identifiers}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"summary-cache-keys",children:"Summary Cache Keys"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"summary:{tenant_id}:{layer}:{entry_id}:{depth}"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Field"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"tenant_id"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsx)(n.td,{children:"Tenant identifier"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"layer"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsxs)(n.td,{children:["Memory layer: ",(0,t.jsx)(n.code,{children:"agent"}),", ",(0,t.jsx)(n.code,{children:"user"}),", ",(0,t.jsx)(n.code,{children:"session"}),", ",(0,t.jsx)(n.code,{children:"project"}),", ",(0,t.jsx)(n.code,{children:"team"}),", ",(0,t.jsx)(n.code,{children:"org"}),", ",(0,t.jsx)(n.code,{children:"company"})]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"entry_id"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsx)(n.td,{children:"Memory entry UUID"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"depth"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsxs)(n.td,{children:["Summary depth: ",(0,t.jsx)(n.code,{children:"sentence"}),", ",(0,t.jsx)(n.code,{children:"paragraph"}),", ",(0,t.jsx)(n.code,{children:"detailed"})]})]})]})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"summary:acme-corp:session:550e8400-e29b-41d4-a716-446655440000:sentence\nsummary:acme-corp:project:myproject-123:paragraph\nsummary:acme-corp:team:api-team:detailed\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Value Schema (JSON):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "depth": "sentence",\n  "content": "This is a one-sentence summary of the memory entry.",\n  "token_count": 47,\n  "generated_at": 1705680000000,\n  "source_hash": "xxhash64:abc123def456",\n  "personalized": false,\n  "personalization_context": null\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"TTL"}),": Configurable via ",(0,t.jsx)(n.code,{children:"cache_ttl_secs"})," (default: 300 seconds)"]}),"\n",(0,t.jsx)(n.h3,{id:"extension-state-keys",children:"Extension State Keys"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"ext_state:{tenant_id}:{session_id}:{extension_id}"})]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Field"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"tenant_id"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsx)(n.td,{children:"Tenant identifier"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"session_id"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsx)(n.td,{children:"Session UUID"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"extension_id"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsx)(n.td,{children:"Extension identifier"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Examples:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"ext_state:acme-corp:sess-123:context-enricher\next_state:acme-corp:sess-456:code-reviewer\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Value Schema (JSON):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "state": {\n    "conversation_history": [...],\n    "custom_field": "value"\n  },\n  "version": 1\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"TTL"}),": Configurable via ",(0,t.jsx)(n.code,{children:"state_ttl_seconds"})," (default: 3600 seconds)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Size Limit"}),": Configurable via ",(0,t.jsx)(n.code,{children:"max_state_size_bytes"})," (default: 1MB)"]}),"\n",(0,t.jsx)(n.h3,{id:"distributed-lock-keys",children:"Distributed Lock Keys"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"lock:{component}:{resource_id}"})]}),"\n",(0,t.jsx)(n.p,{children:"CCA components use these lock patterns:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Component"}),(0,t.jsx)(n.th,{children:"Pattern"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Summary Generator"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:summary_gen:{tenant_id}:{entry_id}"})}),(0,t.jsx)(n.td,{children:"Prevent duplicate summarization"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Note Distillation"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:distill:{tenant_id}:{session_id}"})}),(0,t.jsx)(n.td,{children:"Serialize session distillation"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Hindsight Capture"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:hindsight:{tenant_id}:{error_hash}"})}),(0,t.jsx)(n.td,{children:"Deduplicate error capture"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Meta-Agent Loop"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:meta_loop:{tenant_id}:{loop_id}"})}),(0,t.jsx)(n.td,{children:"Single loop execution"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Value"}),": UUID lock token"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"TTL"}),": Lock-specific (typically 60-300 seconds)"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Lock Acquisition Script (Lua):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'-- SET key value NX EX ttl\nif redis.call("SET", KEYS[1], ARGV[1], "NX", "EX", ARGV[2]) then\n    return "OK"\nelse\n    return nil\nend\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Lock Release Script (Lua):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'if redis.call("GET", KEYS[1]) == ARGV[1] then\n    return redis.call("DEL", KEYS[1])\nelse\n    return 0\nend\n'})}),"\n",(0,t.jsx)(n.h3,{id:"job-coordination-keys",children:"Job Coordination Keys"}),"\n",(0,t.jsx)(n.h4,{id:"job-completion-tracking",children:"Job Completion Tracking"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"job_completed:{job_name}"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),": Deduplication of scheduled jobs"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Value"}),": Timestamp of last completion"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"TTL"}),": Deduplication window (configurable)"]}),"\n",(0,t.jsx)(n.h4,{id:"job-checkpoints",children:"Job Checkpoints"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"job_checkpoint:{job_name}:{tenant_id}"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),": Resume interrupted jobs"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Value Schema (JSON):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "job_name": "summary_refresh",\n  "tenant_id": "acme-corp",\n  "progress": {\n    "processed": 150,\n    "total": 500,\n    "last_entry_id": "entry-123"\n  },\n  "started_at": 1705680000000,\n  "updated_at": 1705680300000\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"event-stream-keys",children:"Event Stream Keys"}),"\n",(0,t.jsx)(n.h4,{id:"trajectory-events",children:"Trajectory Events"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"trajectory:{tenant_id}:{session_id}"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Type"}),": Redis Stream"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),": Capture tool execution events for note-taking"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Entry Schema:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event_id": "evt-123",\n  "timestamp": 1705680000000,\n  "tool_name": "file_edit",\n  "input": "{...}",\n  "output": "{...}",\n  "success": true,\n  "duration_ms": 150,\n  "metadata": "{...}"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Consumer Groups"}),": ",(0,t.jsx)(n.code,{children:"note_taking_workers"})]}),"\n",(0,t.jsx)(n.h4,{id:"governance-events",children:"Governance Events"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"governance:events:{tenant_id}"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Type"}),": Redis Stream"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),": Policy and constraint events for hindsight learning"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Entry Schema:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "event": "{...serialized GovernanceEvent...}"\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"budget-tracking-keys",children:"Budget Tracking Keys"}),"\n",(0,t.jsx)(n.h4,{id:"summarization-budget",children:"Summarization Budget"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"budget:summarization:{tenant_id}:{period}"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Periods"}),": ",(0,t.jsx)(n.code,{children:"hourly:{hour}"}),", ",(0,t.jsx)(n.code,{children:"daily:{date}"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),": Track LLM token usage for cost control"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Value Schema (JSON):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "tokens_used": 45000,\n  "requests": 150,\n  "errors": 2,\n  "period_start": 1705680000000\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"TTL"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Hourly: 2 hours"}),"\n",(0,t.jsx)(n.li,{children:"Daily: 48 hours"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"circuit-breaker-keys",children:"Circuit Breaker Keys"}),"\n",(0,t.jsxs)(n.p,{children:["Pattern: ",(0,t.jsx)(n.code,{children:"circuit:{component}:{tenant_id}"})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),": Track failures for circuit breaker pattern"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Value Schema (JSON):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "state": "closed",\n  "failure_count": 0,\n  "last_failure_at": null,\n  "opened_at": null,\n  "half_open_attempts": 0\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"States"}),": ",(0,t.jsx)(n.code,{children:"closed"}),", ",(0,t.jsx)(n.code,{children:"open"}),", ",(0,t.jsx)(n.code,{children:"half_open"})]}),"\n",(0,t.jsx)(n.h2,{id:"data-structures-by-component",children:"Data Structures by Component"}),"\n",(0,t.jsx)(n.h3,{id:"context-architect",children:"Context Architect"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key Pattern"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"TTL"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"summary:{t}:{l}:{e}:{d}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"300s"}),(0,t.jsx)(n.td,{children:"Summary cache"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:summary_gen:{t}:{e}"})}),(0,t.jsx)(n.td,{children:"String"}),(0,t.jsx)(n.td,{children:"60s"}),(0,t.jsx)(n.td,{children:"Generation lock"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"budget:summarization:{t}:{p}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"2-48h"}),(0,t.jsx)(n.td,{children:"Cost tracking"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"circuit:summarization:{t}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"None"}),(0,t.jsx)(n.td,{children:"LLM circuit breaker"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"note-taking-agent",children:"Note-Taking Agent"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key Pattern"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"TTL"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"trajectory:{t}:{s}"})}),(0,t.jsx)(n.td,{children:"Stream"}),(0,t.jsx)(n.td,{children:"24h"}),(0,t.jsx)(n.td,{children:"Event capture"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:distill:{t}:{s}"})}),(0,t.jsx)(n.td,{children:"String"}),(0,t.jsx)(n.td,{children:"300s"}),(0,t.jsx)(n.td,{children:"Distillation lock"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"job_checkpoint:note_distill:{t}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"1h"}),(0,t.jsx)(n.td,{children:"Resume state"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"hindsight-learning",children:"Hindsight Learning"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key Pattern"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"TTL"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:hindsight:{t}:{h}"})}),(0,t.jsx)(n.td,{children:"String"}),(0,t.jsx)(n.td,{children:"60s"}),(0,t.jsx)(n.td,{children:"Capture lock"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"error_embedding:{t}:{h}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"7d"}),(0,t.jsx)(n.td,{children:"Cached embeddings"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"meta-agent",children:"Meta-Agent"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key Pattern"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"TTL"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"lock:meta_loop:{t}:{l}"})}),(0,t.jsx)(n.td,{children:"String"}),(0,t.jsx)(n.td,{children:"600s"}),(0,t.jsx)(n.td,{children:"Loop execution lock"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"meta_state:{t}:{l}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"1h"}),(0,t.jsx)(n.td,{children:"Loop state"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"job_checkpoint:meta_agent:{t}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"1h"}),(0,t.jsx)(n.td,{children:"Resume state"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"extension-system",children:"Extension System"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key Pattern"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"TTL"}),(0,t.jsx)(n.th,{children:"Purpose"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ext_state:{t}:{s}:{e}"})}),(0,t.jsx)(n.td,{children:"String (JSON)"}),(0,t.jsx)(n.td,{children:"3600s"}),(0,t.jsx)(n.td,{children:"Extension state"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ext_lru:{t}"})}),(0,t.jsx)(n.td,{children:"Sorted Set"}),(0,t.jsx)(n.td,{children:"None"}),(0,t.jsx)(n.td,{children:"LRU eviction tracking"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"memory-management",children:"Memory Management"}),"\n",(0,t.jsx)(n.h3,{id:"lru-eviction-for-extension-state",children:"LRU Eviction for Extension State"}),"\n",(0,t.jsx)(n.p,{children:"When tenant state exceeds configured limits, LRU eviction is triggered:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-redis",children:"-- Track access time in sorted set\nZADD ext_lru:{tenant_id} {timestamp} {session_id}:{extension_id}\n\n-- Find oldest entries\nZRANGE ext_lru:{tenant_id} 0 10\n\n-- Evict oldest entry\nDEL ext_state:{tenant_id}:{oldest_session}:{oldest_extension}\nZREM ext_lru:{tenant_id} {oldest_session}:{oldest_extension}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"compression",children:"Compression"}),"\n",(0,t.jsx)(n.p,{children:"Large state values (>10KB) are compressed with zstd before storage:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:'// Compression prefix indicates compressed data\nconst COMPRESSED_PREFIX: &[u8] = b"ZSTD:";\n\n// Check if value is compressed\nif value.starts_with(COMPRESSED_PREFIX) {\n    let compressed = &value[COMPRESSED_PREFIX.len()..];\n    zstd::decode_all(compressed)?\n} else {\n    value\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"monitoring-keys",children:"Monitoring Keys"}),"\n",(0,t.jsx)(n.h3,{id:"metrics-for-observability-integration",children:"Metrics (for observability integration)"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Metric Key"}),(0,t.jsx)(n.th,{children:"Type"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metrics:cca:summary_latency:{t}"})}),(0,t.jsx)(n.td,{children:"List"}),(0,t.jsx)(n.td,{children:"Summary generation latencies"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metrics:cca:cache_hits:{t}"})}),(0,t.jsx)(n.td,{children:"Counter"}),(0,t.jsx)(n.td,{children:"Summary cache hit count"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metrics:cca:cache_misses:{t}"})}),(0,t.jsx)(n.td,{children:"Counter"}),(0,t.jsx)(n.td,{children:"Summary cache miss count"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metrics:cca:distillation_count:{t}"})}),(0,t.jsx)(n.td,{children:"Counter"}),(0,t.jsx)(n.td,{children:"Notes distilled"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metrics:cca:hindsight_matches:{t}"})}),(0,t.jsx)(n.td,{children:"Counter"}),(0,t.jsx)(n.td,{children:"Error pattern matches"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metrics:cca:ext_evictions:{t}"})}),(0,t.jsx)(n.td,{children:"Counter"}),(0,t.jsx)(n.td,{children:"State evictions"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.h3,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Redis connection\nRD_HOST=localhost\nRD_PORT=6379\nRD_DB=0\n\n# CCA-specific settings (also configurable via config file)\nCCA_CACHE_TTL_SECS=300\nCCA_STATE_TTL_SECS=3600\nCCA_MAX_STATE_BYTES=1048576\n"})}),"\n",(0,t.jsx)(n.h3,{id:"config-file-aeternatoml",children:"Config File (aeterna.toml)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'[storage.redis]\nhost = "localhost"\nport = 6379\ndb = 0\n\n[cca.context_architect]\ncache_ttl_secs = 300\nenable_caching = true\n\n[cca.extension]\nstate_ttl_seconds = 3600\nmax_state_size_bytes = 1048576\n'})}),"\n",(0,t.jsx)(n.h2,{id:"cleanup-procedures",children:"Cleanup Procedures"}),"\n",(0,t.jsx)(n.h3,{id:"expired-cache-cleanup",children:"Expired Cache Cleanup"}),"\n",(0,t.jsx)(n.p,{children:"Summaries use TTL-based expiration. No manual cleanup needed."}),"\n",(0,t.jsx)(n.h3,{id:"orphaned-state-cleanup",children:"Orphaned State Cleanup"}),"\n",(0,t.jsx)(n.p,{children:"For session-scoped state after session end:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# Find orphaned state keys (sessions that ended)\nredis-cli KEYS "ext_state:*" | xargs -I {} redis-cli TTL {}\n\n# Force cleanup of specific tenant\nredis-cli KEYS "ext_state:tenant-id:*" | xargs redis-cli DEL\n'})}),"\n",(0,t.jsx)(n.h3,{id:"stream-trimming",children:"Stream Trimming"}),"\n",(0,t.jsx)(n.p,{children:"Trajectory streams should be trimmed to prevent unbounded growth:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-redis",children:"-- Keep last 1000 entries per stream\nXTRIM trajectory:{tenant_id}:{session_id} MAXLEN ~ 1000\n"})}),"\n",(0,t.jsx)(n.p,{children:"Automated via scheduler:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:'let scheduler = JobScheduler::new()\n    .with_job("stream_trim", Duration::from_secs(3600), |redis| async {\n        redis.xtrim_all_trajectory_streams(1000).await\n    });\n'})}),"\n",(0,t.jsx)(n.h2,{id:"high-availability-considerations",children:"High Availability Considerations"}),"\n",(0,t.jsx)(n.h3,{id:"redis-cluster",children:"Redis Cluster"}),"\n",(0,t.jsx)(n.p,{children:"CCA keys are designed for Redis Cluster compatibility:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"All keys include tenant_id for consistent hashing"}),"\n",(0,t.jsx)(n.li,{children:"No cross-slot operations within atomic transactions"}),"\n",(0,t.jsx)(n.li,{children:"Lock scripts use single-key operations"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"redis-sentinel",children:"Redis Sentinel"}),"\n",(0,t.jsx)(n.p,{children:"For Sentinel deployments, configure connection string:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'[storage.redis]\nconnection_string = "redis+sentinel://sentinel1:26379,sentinel2:26379/mymaster"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"replication-lag",children:"Replication Lag"}),"\n",(0,t.jsx)(n.p,{children:"Summary cache reads tolerate eventual consistency. For critical paths (locks, state), ensure:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-rust",children:"// Use WAIT for synchronous replication on critical writes\nredis.wait(1, Duration::from_millis(100)).await?;\n"})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"high-memory-usage",children:"High Memory Usage"}),"\n",(0,t.jsx)(n.p,{children:"Check key distribution:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'redis-cli --scan --pattern "summary:*" | wc -l\nredis-cli --scan --pattern "ext_state:*" | wc -l\nredis-cli INFO memory\n'})}),"\n",(0,t.jsx)(n.h3,{id:"lock-contention",children:"Lock Contention"}),"\n",(0,t.jsx)(n.p,{children:"Monitor lock acquisition failures:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'redis-cli MONITOR | grep "lock:"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"stream-lag",children:"Stream Lag"}),"\n",(0,t.jsx)(n.p,{children:"Check consumer group lag:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"redis-cli XINFO GROUPS trajectory:tenant-id:session-id\n"})}),"\n",(0,t.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/aeterna/docs/cca/migrations",children:"PostgreSQL Migrations"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/aeterna/docs/cca/configuration",children:"Configuration Guide"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"rollback.md",children:"Rollback Procedures"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453(e,n,s){s.d(n,{R:()=>d,x:()=>c});var i=s(6540);const t={},r=i.createContext(t);function d(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);